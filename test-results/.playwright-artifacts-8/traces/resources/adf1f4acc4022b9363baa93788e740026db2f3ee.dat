globalThis.jotaiAtomCache = globalThis.jotaiAtomCache || {
  cache: /* @__PURE__ */ new Map(),
  get(name, inst) {
    if (this.cache.has(name)) {
      return this.cache.get(name);
    }
    this.cache.set(name, inst);
    return inst;
  }
};
import { mapPower } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/offers/src/adapters/power.adapter.ts";
import { mapGas } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/offers/src/adapters/gas.adapter.ts";
import { applyDiscount } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/offers/src/lib/digital-discount.ts";
const pristineValues = /* @__PURE__ */ new Map();
export function generaCorrispettivi(json, opzioni = {}) {
  const {
    body
  } = json;
  const cacheKey = body.code;
  if (!pristineValues.has(cacheKey)) {
    pristineValues.set(cacheKey, {
      power: deepClone(body.power),
      gas: deepClone(body.gas)
    });
  }
  const original = pristineValues.get(cacheKey);
  const powerOrig = deepClone(original.power);
  const gasOrig = deepClone(original.gas);
  const power = mapPower(powerOrig, opzioni.tariffSelected);
  const gas = mapGas(gasOrig, opzioni.tariffSelected);
  if (power.tariffs_template === "PLACET" || gas.tariffs_template === "PLACET") {
    return null;
  }
  const digitalFactor = getDigitalFactor(body.discounts, opzioni.billSelected);
  const directDebitFactor = getDirectDebitFactor(body.discounts, opzioni.paymentSelected);
  if (digitalFactor) {
    applyDiscount(power, digitalFactor);
    applyDiscount(gas, digitalFactor);
  }
  if (directDebitFactor) {
    applyDiscount(power, directDebitFactor);
    applyDiscount(gas, directDebitFactor);
  }
  return {
    name: body.name,
    code: body.code,
    channel: body.channel,
    touchpoint: body.touchpoint,
    payments: filterByOption(body.payments, opzioni.paymentSelected),
    bills: filterByOption(body.bills, opzioni.billSelected),
    costs: !body.costs || !body.costs.change_offer ? {
      change_offer: "0"
    } : body.costs,
    power,
    gas
  };
}
function filterByOption(list, pick) {
  if (!pick) return list || [];
  if (!list) return [];
  return list.includes(pick) ? [pick] : [];
}
function deepClone(obj) {
  return JSON.parse(JSON.stringify(obj));
}
function getDigitalFactor(discounts, billSelected) {
  if (billSelected !== "DIGITAL") return null;
  const found = discounts.find((d) => d.type === "digital");
  if (!found) return null;
  const factor = +found.value.replace(",", ".");
  return Number.isFinite(factor) ? factor : null;
}
function getDirectDebitFactor(discounts, paymentSelected) {
  if (paymentSelected !== "DIRECT") return null;
  const found = discounts.find((d) => d.type === "direct_debit");
  if (!found) return null;
  const factor = +found.value.replace(",", ".");
  return Number.isFinite(factor) ? factor : null;
}

//# sourceMappingURL=data:application/json;base64,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QU1nQixRQUFRcEIsVUFBVXFCLEtBQUtDLE9BQUtBLEVBQUVDLFNBQVMsY0FBYztBQUMzRCxNQUFJLENBQUNILE1BQU8sUUFBTztBQUVuQixRQUFNSSxTQUFTLENBQUNKLE1BQU1LLE1BQU1DLFFBQVEsS0FBSyxHQUFHO0FBQzVDLFNBQU9DLE9BQU9DLFNBQVNKLE1BQU0sSUFBSUEsU0FBUztBQUM1QyIsIm5hbWVzIjpbIm1hcFBvd2VyIiwibWFwR2FzIiwiYXBwbHlEaXNjb3VudCIsInByaXN0aW5lVmFsdWVzIiwiTWFwIiwiZ2VuZXJhQ29ycmlzcGV0dGl2aSIsImpzb24iLCJvcHppb25pIiwiYm9keSIsImNhY2hlS2V5IiwiY29kZSIsImhhcyIsInNldCIsInBvd2VyIiwiZGVlcENsb25lIiwiZ2FzIiwib3JpZ2luYWwiLCJnZXQiLCJwb3dlck9yaWciLCJnYXNPcmlnIiwidGFyaWZmU2VsZWN0ZWQiLCJ0YXJpZmZzX3RlbXBsYXRlIiwiZGlnaXRhbEZhY3RvciIsImdldERpZ2l0YWxGYWN0b3IiLCJkaXNjb3VudHMiLCJiaWxsU2VsZWN0ZWQiLCJkaXJlY3REZWJpdEZhY3RvciIsImdldERpcmVjdERlYml0RmFjdG9yIiwicGF5bWVudFNlbGVjdGVkIiwibmFtZSIsImNoYW5uZWwiLCJ0b3VjaHBvaW50IiwicGF5bWVudHMiLCJmaWx0ZXJCeU9wdGlvbiIsImJpbGxzIiwiY29zdHMiLCJjaGFuZ2Vfb2ZmZXIiLCJsaXN0IiwicGljayIsImluY2x1ZGVzIiwib2JqIiwiSlNPTiIsInBhcnNlIiwic3RyaW5naWZ5IiwiZm91bmQiLCJmaW5kIiwiZCIsInR5cGUiLCJmYWN0b3IiLCJ2YWx1ZSIsInJlcGxhY2UiLCJOdW1iZXIiLCJpc0Zpbml0ZSJdLCJpZ25vcmVMaXN0IjpbXSwic291cmNlcyI6WyJvZmZlci5hZGFwdGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7T3B6aW9uaVNlbGV6aW9uYXRlfSBmcm9tIFwiLi4vbW9kZWxzL29wdGlvbnNcIjtcclxuaW1wb3J0IHtJbmZvT2ZmZXJ0YUZyb250ZW5kfSBmcm9tIFwiLi4vbW9kZWxzL2luZm8tb2ZmZXJ0YS1mcm9udGVuZFwiO1xyXG5pbXBvcnQge21hcFBvd2VyfSBmcm9tIFwiLi9wb3dlci5hZGFwdGVyXCI7XHJcbmltcG9ydCB7bWFwR2FzfSBmcm9tIFwiLi9nYXMuYWRhcHRlclwiO1xyXG5pbXBvcnQge0JpbGxNZXRob2QsIERldGFpbHNQcm9kb3R0b1ZlbmRpYmlsZVJlc3BvbnNlLCBEaXNjb3VudCwgUGF5bWVudE1ldGhvZH0gZnJvbSBcIi4uL21vZGVscy9pbmZvLW9mZmVydGEtcm9vdFwiO1xyXG5pbXBvcnQge2FwcGx5RGlzY291bnR9IGZyb20gXCIuLi9saWIvZGlnaXRhbC1kaXNjb3VudFwiO1xyXG5cclxuLyoqXHJcbiAqIExhIGNhY2hlIHNlcnZlIHBlciBjb250cm9sbGFyZSBzZSDDqCBnacOgIHN0YXRvIGZhdHRvIGlsIHByaW1vIG1hcHBpbmdcclxuICogaW4gbW9kbyBkYSBnZXN0aXJlIGdsaSBzY29udGkgcGVyIG1ldHRlcmxpIGUgdG9nbGllcmxpXHJcbiAqL1xyXG5cclxuICAvLyBDYWNoZSBkZWkgdmFsb3JpIOKAnHByaXN0aW5l4oCdLCBtYWkgdG9jY2F0aSBkYWkgbWFwcGVyXHJcbmNvbnN0IHByaXN0aW5lVmFsdWVzID0gbmV3IE1hcDxzdHJpbmcsIFJlYWRvbmx5PHsgcG93ZXI6IGFueTsgZ2FzOiBhbnkgfT4+KCk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhQ29ycmlzcGV0dGl2aShcclxuICBqc29uOiBEZXRhaWxzUHJvZG90dG9WZW5kaWJpbGVSZXNwb25zZSxcclxuICBvcHppb25pOiBPcHppb25pU2VsZXppb25hdGUgPSB7fVxyXG4pOiBJbmZvT2ZmZXJ0YUZyb250ZW5kIHwgbnVsbCB7XHJcblxyXG4gIGNvbnN0IHtib2R5fSA9IGpzb247XHJcbiAgY29uc3QgY2FjaGVLZXkgPSBib2R5LmNvZGU7XHJcblxyXG4gIC8qIOKHoiAxLiBJbml6aWFsaXp6byBsYSBjYWNoZSBzb2xvIHVuYSB2b2x0YSAqL1xyXG4gIGlmICghcHJpc3RpbmVWYWx1ZXMuaGFzKGNhY2hlS2V5KSkge1xyXG4gICAgcHJpc3RpbmVWYWx1ZXMuc2V0KGNhY2hlS2V5LCB7XHJcbiAgICAgIHBvd2VyOiBkZWVwQ2xvbmUoYm9keS5wb3dlciksXHJcbiAgICAgIGdhczogZGVlcENsb25lKGJvZHkuZ2FzKVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKiDih6IgMi4gUGFydG8gb2duaSB2b2x0YSBkYSB1biBjbG9uZSBmcmVzY28gKi9cclxuICBjb25zdCBvcmlnaW5hbCA9IHByaXN0aW5lVmFsdWVzLmdldChjYWNoZUtleSkhO1xyXG4gIGNvbnN0IHBvd2VyT3JpZyA9IGRlZXBDbG9uZShvcmlnaW5hbC5wb3dlcik7XHJcbiAgY29uc3QgZ2FzT3JpZyA9IGRlZXBDbG9uZShvcmlnaW5hbC5nYXMpO1xyXG5cclxuICAvKiDih6IgbWFwcGluZyBjb24gbGUgb3B6aW9uaSBhdHR1YWxpICovXHJcbiAgY29uc3QgcG93ZXIgPSBtYXBQb3dlcihwb3dlck9yaWcsIG9wemlvbmkudGFyaWZmU2VsZWN0ZWQpO1xyXG4gIGNvbnN0IGdhcyA9IG1hcEdhcyhnYXNPcmlnLCBvcHppb25pLnRhcmlmZlNlbGVjdGVkKTtcclxuXHJcbiAgLyog4oeiIGVzY2x1c2lvbmUgUExBQ0VUICovXHJcbiAgaWYgKHBvd2VyLnRhcmlmZnNfdGVtcGxhdGUgPT09IFwiUExBQ0VUXCIgfHwgZ2FzLnRhcmlmZnNfdGVtcGxhdGUgPT09IFwiUExBQ0VUXCIpIHtcclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgLyog4oeiIHNjb250aSAqL1xyXG4gIGNvbnN0IGRpZ2l0YWxGYWN0b3IgPSBnZXREaWdpdGFsRmFjdG9yKGJvZHkuZGlzY291bnRzLCBvcHppb25pLmJpbGxTZWxlY3RlZCk7XHJcbiAgY29uc3QgZGlyZWN0RGViaXRGYWN0b3IgPSBnZXREaXJlY3REZWJpdEZhY3Rvcihib2R5LmRpc2NvdW50cywgb3B6aW9uaS5wYXltZW50U2VsZWN0ZWQpO1xyXG5cclxuICBpZiAoZGlnaXRhbEZhY3Rvcikge1xyXG4gICAgYXBwbHlEaXNjb3VudChwb3dlciwgZGlnaXRhbEZhY3Rvcik7XHJcbiAgICBhcHBseURpc2NvdW50KGdhcywgZGlnaXRhbEZhY3Rvcik7XHJcbiAgfVxyXG4gIGlmIChkaXJlY3REZWJpdEZhY3Rvcikge1xyXG4gICAgYXBwbHlEaXNjb3VudChwb3dlciwgZGlyZWN0RGViaXRGYWN0b3IpO1xyXG4gICAgYXBwbHlEaXNjb3VudChnYXMsIGRpcmVjdERlYml0RmFjdG9yKTtcclxuICB9XHJcblxyXG4gIC8qIOKHoiByaXN1bHRhdG8gKi9cclxuICByZXR1cm4ge1xyXG4gICAgbmFtZTogYm9keS5uYW1lLFxyXG4gICAgY29kZTogYm9keS5jb2RlLFxyXG4gICAgY2hhbm5lbDogYm9keS5jaGFubmVsLFxyXG4gICAgdG91Y2hwb2ludDogYm9keS50b3VjaHBvaW50LFxyXG4gICAgcGF5bWVudHM6IGZpbHRlckJ5T3B0aW9uKGJvZHkucGF5bWVudHMsIG9wemlvbmkucGF5bWVudFNlbGVjdGVkKSxcclxuICAgIGJpbGxzOiBmaWx0ZXJCeU9wdGlvbihib2R5LmJpbGxzLCBvcHppb25pLmJpbGxTZWxlY3RlZCksXHJcbiAgICBjb3N0czogKCFib2R5LmNvc3RzIHx8ICFib2R5LmNvc3RzLmNoYW5nZV9vZmZlcikgPyB7Y2hhbmdlX29mZmVyOiBcIjBcIn0gOiBib2R5LmNvc3RzLFxyXG4gICAgcG93ZXIsXHJcbiAgICBnYXNcclxuICB9O1xyXG59XHJcblxyXG5cclxuLyoqIHV0aWxpdHkgZ2VuZXJpY2EgKi9cclxuZnVuY3Rpb24gZmlsdGVyQnlPcHRpb248VD4obGlzdD86IFRbXSwgcGljaz86IFQpOiBUW10ge1xyXG4gIGlmICghcGljaykgcmV0dXJuIGxpc3QgfHwgW107XHJcbiAgaWYgKCFsaXN0KSByZXR1cm4gW107XHJcbiAgcmV0dXJuIGxpc3QuaW5jbHVkZXMocGljaykgPyBbcGlja10gOiBbXTtcclxufVxyXG5cclxuZnVuY3Rpb24gZGVlcENsb25lPFQ+KG9iajogVCk6IFQge1xyXG4gIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpO1xyXG59XHJcblxyXG4vKipcclxuICogY29udHJvbGxhIHNlIMOoIHByZXNlbnRlIGxvIHNjb250byBwZXIgYm9sbGV0dGEgZGlnaXRhbGVcclxuICogQHBhcmFtIGRpc2NvdW50c1xyXG4gKiBAcGFyYW0gYmlsbFNlbGVjdGVkXHJcbiAqL1xyXG5mdW5jdGlvbiBnZXREaWdpdGFsRmFjdG9yKFxyXG4gIGRpc2NvdW50czogRGlzY291bnRbXSxcclxuICBiaWxsU2VsZWN0ZWQ/OiBCaWxsTWV0aG9kLFxyXG4pOiBudW1iZXIgfCBudWxsIHtcclxuICBpZiAoYmlsbFNlbGVjdGVkICE9PSBcIkRJR0lUQUxcIikgcmV0dXJuIG51bGw7XHJcblxyXG4gIGNvbnN0IGZvdW5kID0gZGlzY291bnRzLmZpbmQoZCA9PiBkLnR5cGUgPT09IFwiZGlnaXRhbFwiKTtcclxuICBpZiAoIWZvdW5kKSByZXR1cm4gbnVsbDtcclxuXHJcbiAgY29uc3QgZmFjdG9yID0gK2ZvdW5kLnZhbHVlLnJlcGxhY2UoXCIsXCIsIFwiLlwiKTsgLy8gXCIwLDk1XCIg4oaSIDAuOTVcclxuICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKGZhY3RvcikgPyBmYWN0b3IgOiBudWxsO1xyXG59XHJcblxyXG4vKipcclxuICogY29udHJvbGxhIHNlIMOoIHByZXNlbnRlIGxvIHNjb250byBwZXIgbGEgZG9taWNpbGlhemlvbmUgKGFkZGViaXRvIGRpcmV0dG8pXHJcbiAqIEBwYXJhbSBkaXNjb3VudHNcclxuICogQHBhcmFtIHBheW1lbnRTZWxlY3RlZFxyXG4gKi9cclxuZnVuY3Rpb24gZ2V0RGlyZWN0RGViaXRGYWN0b3IoXHJcbiAgZGlzY291bnRzOiBEaXNjb3VudFtdLFxyXG4gIHBheW1lbnRTZWxlY3RlZD86IFBheW1lbnRNZXRob2QsXHJcbik6IG51bWJlciB8IG51bGwge1xyXG4gIGlmIChwYXltZW50U2VsZWN0ZWQgIT09IFwiRElSRUNUXCIpIHJldHVybiBudWxsO1xyXG5cclxuICBjb25zdCBmb3VuZCA9IGRpc2NvdW50cy5maW5kKGQgPT4gZC50eXBlID09PSBcImRpcmVjdF9kZWJpdFwiKTtcclxuICBpZiAoIWZvdW5kKSByZXR1cm4gbnVsbDtcclxuXHJcbiAgY29uc3QgZmFjdG9yID0gK2ZvdW5kLnZhbHVlLnJlcGxhY2UoXCIsXCIsIFwiLlwiKTsgLy8gXCIwLDk1XCIg4oaSIDAuOTVcclxuICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKGZhY3RvcikgPyBmYWN0b3IgOiBudWxsO1xyXG59XHJcbiJdLCJmaWxlIjoiQzovVXNlcnMvYWludHJvbmEvRGVza3RvcC9BcHAvcmVhY3QvbmFqL2xpYnMvb2ZmZXJzL3NyYy9hZGFwdGVycy9vZmZlci5hZGFwdGVyLnRzIn0=