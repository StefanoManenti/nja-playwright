globalThis.jotaiAtomCache = globalThis.jotaiAtomCache || {
  cache: /* @__PURE__ */ new Map(),
  get(name, inst) {
    if (this.cache.has(name)) {
      return this.cache.get(name);
    }
    this.cache.set(name, inst);
    return inst;
  }
};
import { deepEquals, PreconditionFailedError, ServiceUnhandledResponseError } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/util/src/index.ts";
import { atom } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/node_modules/.vite/apps/naj/deps/jotai.js?v=0189a8d1";
import { atomFamily } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/node_modules/.vite/apps/naj/deps/jotai_utils.js?v=0189a8d1";
import { broadband$ } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/data-access/src/lib/atoms/broadband/broadband.ts";
import { currentContractInfoAtom } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/data-access/src/lib/atoms/current-contract-info-atoms.ts";
import { Segment } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/data-access/src/lib/atoms/enums.ts";
import { TransferType, transferTypeAtom } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/data-access/src/lib/atoms/transfer.ts";
import { CreditCheckError, Ddl009_010Error } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/data-access/src/lib/errors/index.ts";
import { workingProductAtom } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/data-access/src/lib/troubleshooting/troubleshooting.ts";
import { OperativeMode, Payment } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/data-access/src/lib/troubleshooting/types.ts";
import { API, generateOperationID } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/data-access/src/lib/utils/index.ts";
import { atomWithErrorReset } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/data-access/src/lib/utils/atomWithRetryableQuery.ts";
import { areCheckBypassed } from "/@fs/C:/Users/aintrona/Desktop/App/react/naj/libs/data-access/src/lib/utils/flags.ts";
async function fetchCreditCheck(payload) {
  if (areCheckBypassed()) {
    return {
      customerInWhitelist: true
    };
  }
  const logHash = generateOperationID();
  const data1 = {
    caller: "WEB",
    logHash,
    plicoCode: payload.plicoCode,
    fiscalCode: payload.fiscalCode,
    vatNumber: payload.vatNumber,
    idLead: payload.idLead,
    modalitaOperativa: payload.modalitaOperativa,
    checkTypes: payload.checkTypes
  };
  if (payload.checkTypes === "CREDIT,SCORECARD") {
    data1.iban = payload.iban;
  }
  const response = await fetch(`${API}/webOrderCommonServices/v1.1/creditCheck`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Accept: "application/json"
    },
    body: JSON.stringify(data1)
  });
  if (response.status !== 200) {
    throw new ServiceUnhandledResponseError(response.statusText, logHash, response);
  }
  const data = await response.json();
  if (data.errorManagement?.errorCode === "DDL_009" || data.errorManagement?.errorCode === "DDL_010") {
    throw new Ddl009_010Error(data.errorManagement?.errorCode, logHash, response);
  }
  if (data.status !== "Success") {
    throw new ServiceUnhandledResponseError(data.status, logHash, response);
  }
  if (data.result !== "001") {
    throw new ServiceUnhandledResponseError(data.result, logHash, response);
  }
  const esito = checkEsito(data.response.creditCheck?.esito, (x) => JSON.parse(x)) && checkEsito(data.response.scorecard?.esito) && checkEsito(data.response.insolutoNDS?.esito);
  if (!esito) {
    throw new CreditCheckError("KO_CREDIT_CHECK", logHash, response);
  }
  return {
    customerInWhitelist: data.response.creditCheck?.dettaglio.whitelist === "OK"
  };
}
function checkEsito(v, parse = (x) => !!x) {
  if (v == null) {
    return true;
  }
  return parse(v);
}
const fetchCreditCheckAtom = globalThis.jotaiAtomCache.get("C:\\Users\\aintrona\\Desktop\\App\\react\\naj\\libs\\data-access\\src\\lib\\api\\weborder\\creditCheck.ts/fetchCreditCheckAtom", atomFamily((...params) => atomWithErrorReset(() => fetchCreditCheck(...params)), (a, b) => deepEquals(a, b)));
fetchCreditCheckAtom.debugLabel = "fetchCreditCheckAtom";
async function _checkCredit(get, customer$, paymentData, modalitaOperativa) {
  const contract = get(currentContractInfoAtom);
  const idLead = contract.idLead;
  const plicoCode = await contract.plicoCode;
  const vatOrTaxId = await getVatOrTaxId(get, customer$);
  const paymentType = await get(paymentData.paymentType$);
  if (paymentType === Payment.DOMICILIATION) {
    const tool = await get(paymentData.paymentTool$);
    if (tool == null) {
      throw new PreconditionFailedError("Payment type is domiciliation but no iban is defined.");
    }
    const iban = tool.iban;
    return get(fetchCreditCheckAtom({
      idLead,
      plicoCode,
      modalitaOperativa,
      checkTypes: "CREDIT,SCORECARD",
      iban,
      ...vatOrTaxId
    }));
  }
  return get(fetchCreditCheckAtom({
    idLead,
    plicoCode,
    modalitaOperativa,
    checkTypes: "CREDIT",
    ...vatOrTaxId
  }));
}
async function getVatOrTaxId(get, customer$) {
  const customer = await get(customer$);
  const profile = customer.profile;
  const segment = await get(customer.segment);
  const vatOrTaxId = segment === Segment.SMALL ? {
    vatNumber: await get(profile.vatNumber$)
  } : {
    fiscalCode: await get(profile.taxId$)
  };
  if (vatOrTaxId.fiscalCode == null && vatOrTaxId.vatNumber == null) {
    throw new PreconditionFailedError("TaxId is empty");
  }
  return vatOrTaxId;
}
export const atomWithCheckCredit = (customer$, paymentData) => atomWithErrorReset(async (get) => {
  const transferType = await get(transferTypeAtom);
  if (transferType === TransferType.MORTIS_CAUSA) {
    return {
      customerInWhitelist: true
    };
  }
  const salesProcesses = await get(checkCreditSalesProcesses$);
  console.debug(salesProcesses);
  const promises = salesProcesses.map((modalitaOperativa) => _checkCredit(get, customer$, paymentData, modalitaOperativa));
  const results = await Promise.all(promises);
  return {
    customerInWhitelist: results.reduce((previousValue, currentValue) => previousValue && currentValue.customerInWhitelist, true)
  };
});
const checkCreditSalesProcesses$ = globalThis.jotaiAtomCache.get("C:\\Users\\aintrona\\Desktop\\App\\react\\naj\\libs\\data-access\\src\\lib\\api\\weborder\\creditCheck.ts/checkCreditSalesProcesses$", atom(async (get) => {
  const wp = get(workingProductAtom);
  if (wp == null) {
    return ["ALTRO"];
  }
  const toReturn = /* @__PURE__ */ new Set();
  if (wp.commodity) {
    const modalitaOperativa = getCheckCreditCommodityModalitaOperativa(wp.operativeMode);
    if (modalitaOperativa) {
      toReturn.add(modalitaOperativa);
    }
  }
  if (wp.broadband) {
    const broadband = await get(broadband$);
    const modalitaOperativa = get(broadband.salesProcess$);
    toReturn.add(modalitaOperativa);
  }
  if (!toReturn.size) {
    toReturn.add("ALTRO");
  }
  return [...toReturn.values()];
}));
checkCreditSalesProcesses$.debugLabel = "checkCreditSalesProcesses$";
function getCheckCreditCommodityModalitaOperativa(operativeMode) {
  switch (operativeMode) {
    case OperativeMode.SWITCH_IN:
      return "SWITCH IN";
    case OperativeMode.SWITCH_IN_TRANSFER:
      return "VOLTURA CON SWITCH";
    case OperativeMode.TRANSFER:
      return "VOLTURA";
    case OperativeMode.NEW_ACTIVATION:
      return "ATTIVAZIONE";
    case OperativeMode.CHANGE_OFFER:
      return "CAMBIO PRODOTTO";
  }
}

//# sourceMappingURL=data:application/json;base64,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LEdBQUdHLFdBQVc7QUFDaEIsVUFBTXZFLG9CQUFvQndFLHlDQUN4QkosR0FBR0ssYUFDTDtBQUNBLFFBQUl6RSxtQkFBbUI7QUFDckJxRSxlQUFTSyxJQUFJMUUsaUJBQWlCO0FBQUEsSUFDaEM7QUFBQSxFQUNGO0FBQ0EsTUFBSW9FLEdBQUdPLFdBQVc7QUFDaEIsVUFBTUEsWUFBWSxNQUFNNUMsSUFBSXZELFVBQVU7QUFDdEMsVUFBTXdCLG9CQUFvQitCLElBQUk0QyxVQUFVQyxhQUFhO0FBQ3JEUCxhQUFTSyxJQUFJMUUsaUJBQWlCO0FBQUEsRUFDaEM7QUFFQSxNQUFJLENBQUNxRSxTQUFTUSxNQUFNO0FBQ2xCUixhQUFTSyxJQUFJLE9BQU87QUFBQSxFQUN0QjtBQUVBLFNBQU8sQ0FBQyxHQUFHTCxTQUFTUyxPQUFPLENBQUM7QUFDOUIsQ0FBQyxDQUFDO0FBQUFyQiwyQkFBQXRCLGFBQUE7QUFFRixTQUFTcUMseUNBQ1BDLGVBQzBDO0FBQzFDLFVBQVFBLGVBQWE7QUFBQSxJQUNuQixLQUFLekYsY0FBYytGO0FBQ2pCLGFBQU87QUFBQSxJQUNULEtBQUsvRixjQUFjZ0c7QUFDakIsYUFBTztBQUFBLElBQ1QsS0FBS2hHLGNBQWNpRztBQUNqQixhQUFPO0FBQUEsSUFDVCxLQUFLakcsY0FBY2tHO0FBQ2pCLGFBQU87QUFBQSxJQUNULEtBQUtsRyxjQUFjbUc7QUFDakIsYUFBTztBQUFBLEVBQ1g7QUFDRiIsIm5hbWVzIjpbImRlZXBFcXVhbHMiLCJQcmVjb25kaXRpb25GYWlsZWRFcnJvciIsIlNlcnZpY2VVbmhhbmRsZWRSZXNwb25zZUVycm9yIiwiYXRvbSIsImF0b21GYW1pbHkiLCJicm9hZGJhbmQkIiwiY3VycmVudENvbnRyYWN0SW5mb0F0b20iLCJTZWdtZW50IiwiVHJhbnNmZXJUeXBlIiwidHJhbnNmZXJUeXBlQXRvbSIsIkNyZWRpdENoZWNrRXJyb3IiLCJEZGwwMDlfMDEwRXJyb3IiLCJ3b3JraW5nUHJvZHVjdEF0b20iLCJPcGVyYXRpdmVNb2RlIiwiUGF5bWVudCIsIkFQSSIsImdlbmVyYXRlT3BlcmF0aW9uSUQiLCJhdG9tV2l0aEVycm9yUmVzZXQiLCJhcmVDaGVja0J5cGFzc2VkIiwiZmV0Y2hDcmVkaXRDaGVjayIsInBheWxvYWQiLCJjdXN0b21lckluV2hpdGVsaXN0IiwibG9nSGFzaCIsImRhdGExIiwiY2FsbGVyIiwicGxpY29Db2RlIiwiZmlzY2FsQ29kZSIsInZhdE51bWJlciIsImlkTGVhZCIsIm1vZGFsaXRhT3BlcmF0aXZhIiwiY2hlY2tUeXBlcyIsImliYW4iLCJyZXNwb25zZSIsImZldGNoIiwibWV0aG9kIiwiaGVhZGVycyIsIkFjY2VwdCIsImJvZHkiLCJKU09OIiwic3RyaW5naWZ5Iiwic3RhdHVzIiwic3RhdHVzVGV4dCIsImRhdGEiLCJqc29uIiwiZXJyb3JNYW5hZ2VtZW50IiwiZXJyb3JDb2RlIiwicmVzdWx0IiwiZXNpdG8iLCJjaGVja0VzaXRvIiwiY3JlZGl0Q2hlY2siLCJ4IiwicGFyc2UiLCJzY29yZWNhcmQiLCJpbnNvbHV0b05EUyIsImRldHRhZ2xpbyIsIndoaXRlbGlzdCIsInYiLCJmZXRjaENyZWRpdENoZWNrQXRvbSIsImdsb2JhbFRoaXMiLCJqb3RhaUF0b21DYWNoZSIsImdldCIsInBhcmFtcyIsImEiLCJiIiwiZGVidWdMYWJlbCIsIl9jaGVja0NyZWRpdCIsImN1c3RvbWVyJCIsInBheW1lbnREYXRhIiwiY29udHJhY3QiLCJ2YXRPclRheElkIiwiZ2V0VmF0T3JUYXhJZCIsInBheW1lbnRUeXBlIiwicGF5bWVudFR5cGUkIiwiRE9NSUNJTElBVElPTiIsInRvb2wiLCJwYXltZW50VG9vbCQiLCJjdXN0b21lciIsInByb2ZpbGUiLCJzZWdtZW50IiwiU01BTEwiLCJ2YXROdW1iZXIkIiwidGF4SWQkIiwiYXRvbVdpdGhDaGVja0NyZWRpdCIsInRyYW5zZmVyVHlwZSIsIk1PUlRJU19DQVVTQSIsInNhbGVzUHJvY2Vzc2VzIiwiY2hlY2tDcmVkaXRTYWxlc1Byb2Nlc3NlcyQiLCJjb25zb2xlIiwiZGVidWciLCJwcm9taXNlcyIsIm1hcCIsInJlc3VsdHMiLCJQcm9taXNlIiwiYWxsIiwicmVkdWNlIiwicHJldmlvdXNWYWx1ZSIsImN1cnJlbnRWYWx1ZSIsIndwIiwidG9SZXR1cm4iLCJTZXQiLCJjb21tb2RpdHkiLCJnZXRDaGVja0NyZWRpdENvbW1vZGl0eU1vZGFsaXRhT3BlcmF0aXZhIiwib3BlcmF0aXZlTW9kZSIsImFkZCIsImJyb2FkYmFuZCIsInNhbGVzUHJvY2VzcyQiLCJzaXplIiwidmFsdWVzIiwiU1dJVENIX0lOIiwiU1dJVENIX0lOX1RSQU5TRkVSIiwiVFJBTlNGRVIiLCJORVdfQUNUSVZBVElPTiIsIkNIQU5HRV9PRkZFUiJdLCJpZ25vcmVMaXN0IjpbXSwic291cmNlcyI6WyJjcmVkaXRDaGVjay50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIGRlZXBFcXVhbHMsXHJcbiAgUHJlY29uZGl0aW9uRmFpbGVkRXJyb3IsXHJcbiAgU2VydmljZVVuaGFuZGxlZFJlc3BvbnNlRXJyb3IsXHJcbn0gZnJvbSAnQG5hai13by91dGlsJztcclxuaW1wb3J0IHsgYXRvbSwgR2V0dGVyIH0gZnJvbSAnam90YWknO1xyXG5pbXBvcnQgeyBhdG9tRmFtaWx5IH0gZnJvbSAnam90YWkvdXRpbHMnO1xyXG5pbXBvcnQgeyBicm9hZGJhbmQkIH0gZnJvbSAnLi4vLi4vYXRvbXMvYnJvYWRiYW5kL2Jyb2FkYmFuZCc7XHJcbmltcG9ydCB7IGN1cnJlbnRDb250cmFjdEluZm9BdG9tIH0gZnJvbSAnLi4vLi4vYXRvbXMvY3VycmVudC1jb250cmFjdC1pbmZvLWF0b21zJztcclxuaW1wb3J0IHsgU2VnbWVudCB9IGZyb20gJy4uLy4uL2F0b21zL2VudW1zJztcclxuaW1wb3J0IHsgVHJhbnNmZXJUeXBlLCB0cmFuc2ZlclR5cGVBdG9tIH0gZnJvbSAnLi4vLi4vYXRvbXMvdHJhbnNmZXInO1xyXG5pbXBvcnQgdHlwZSB7IEFzeW5jQXRvbSwgQ3VzdG9tZXIsIFBheW1lbnREYXRhIH0gZnJvbSAnLi4vLi4vYXRvbXMvdHlwZXMnO1xyXG5pbXBvcnQgeyBDcmVkaXRDaGVja0Vycm9yLCBEZGwwMDlfMDEwRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMnO1xyXG5pbXBvcnQgeyB3b3JraW5nUHJvZHVjdEF0b20gfSBmcm9tICcuLi8uLi90cm91Ymxlc2hvb3RpbmcvdHJvdWJsZXNob290aW5nJztcclxuaW1wb3J0IHsgT3BlcmF0aXZlTW9kZSwgUGF5bWVudCB9IGZyb20gJy4uLy4uL3Ryb3VibGVzaG9vdGluZy90eXBlcyc7XHJcbmltcG9ydCB7IEFQSSwgZ2VuZXJhdGVPcGVyYXRpb25JRCB9IGZyb20gJy4uLy4uL3V0aWxzJztcclxuaW1wb3J0IHsgYXRvbVdpdGhFcnJvclJlc2V0IH0gZnJvbSAnLi4vLi4vdXRpbHMvYXRvbVdpdGhSZXRyeWFibGVRdWVyeSc7XHJcbmltcG9ydCB7IGFyZUNoZWNrQnlwYXNzZWQgfSBmcm9tICcuLi8uLi91dGlscy9mbGFncyc7XHJcblxyXG50eXBlIFN1cGVyYXRvID0gJ1NVUEVSQVRPJyB8ICdOT04gU1VQRVJBVE8nIHwgJ09LJyB8ICdOT04gTkVDRVNTQVJJTyc7XHJcblxyXG50eXBlIFdTT3V0cHV0ID0ge1xyXG4gIGlkOiBudWxsO1xyXG4gIHJlc3VsdDogJzAwMScgfCBzdHJpbmc7XHJcbiAgc3RhdHVzOiAnU3VjY2VzcycgfCBzdHJpbmc7XHJcbiAgcmVzcG9uc2U6IHtcclxuICAgIGVzaXRvOiBudWxsO1xyXG4gICAgY3JlZGl0Q2hlY2s/OiB7XHJcbiAgICAgIGVzaXRvOiAndHJ1ZSc7XHJcbiAgICAgIGRldHRhZ2xpbzoge1xyXG4gICAgICAgIHdoaXRlbGlzdDogU3VwZXJhdG87XHJcbiAgICAgICAgYmxhY2tsaXN0OiBTdXBlcmF0bztcclxuICAgICAgICBibGFja2xpc3RfMjogU3VwZXJhdG87XHJcbiAgICAgICAgYmxhY2tsaXN0XzM6IFN1cGVyYXRvO1xyXG4gICAgICB9O1xyXG4gICAgICBjYWxsU2NvcmVjYXJkOiB0cnVlO1xyXG4gICAgfTtcclxuICAgIHNjb3JlY2FyZD86IHtcclxuICAgICAgZXNpdG86IHRydWU7XHJcbiAgICAgIGRldHRhZ2xpbzogJ05PTiBESVNQT05JQklMRSc7XHJcbiAgICB9O1xyXG4gICAgaW5zb2x1dG9ORFM/OiB7XHJcbiAgICAgIGVzaXRvOiB0cnVlO1xyXG4gICAgICBkZXR0YWdsaW86IHtcclxuICAgICAgICBpbnNvbHV0b196dW9yYV9jZjogJ09LJztcclxuICAgICAgICBpbnNvbHV0b196dW9yYV9pYmFuOiAnT0snO1xyXG4gICAgICAgIGluc29sdXRvX3p1b3JhX2VtYWlsOiAnJztcclxuICAgICAgICBpbnNvbHV0b196dW9yYV90ZWxlZm9ubzogJyc7XHJcbiAgICAgIH07XHJcbiAgICAgIGRlc2NyaXppb25lRXNpdG86ICcnO1xyXG4gICAgfTtcclxuICAgIGVzaXRvQ0Y6IG51bGw7XHJcbiAgfTtcclxuICBlcnJvck1hbmFnZW1lbnQ6IHtcclxuICAgIGVycm9yQ29kZTogc3RyaW5nO1xyXG4gICAgZXJyb3JEZXNjcmlwdGlvbjogc3RyaW5nO1xyXG4gIH0gfCBudWxsO1xyXG4gIGxvZ0hhc2g6IHN0cmluZztcclxuICBpZExlYWQ6IHN0cmluZztcclxuICBwbGljb0NvZGU6IG51bGw7XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBDcmVkaXRDaGVja0Jhc2VJbnB1dCA9IHtcclxuICBwbGljb0NvZGU6IHN0cmluZztcclxuICBpZExlYWQ6IHN0cmluZztcclxuICBtb2RhbGl0YU9wZXJhdGl2YTogQ2hlY2tDcmVkaXRNb2RhbGl0YU9wZXJhdGl2YTtcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIENyZWRpdENoZWNrQ3VzdG9tZXJJbnB1dCA9XHJcbiAgfCB7XHJcbiAgICAgIGZpc2NhbENvZGU6IHN0cmluZztcclxuICAgICAgdmF0TnVtYmVyPzogbmV2ZXI7XHJcbiAgICB9XHJcbiAgfCB7XHJcbiAgICAgIGZpc2NhbENvZGU/OiBuZXZlcjtcclxuICAgICAgdmF0TnVtYmVyOiBzdHJpbmc7XHJcbiAgICB9O1xyXG5cclxuZXhwb3J0IHR5cGUgQ3JlZGl0Q2hlY2tEYXRhSW5wdXQgPVxyXG4gIHwge1xyXG4gICAgICBjaGVja1R5cGVzOiAnQ1JFRElULFNDT1JFQ0FSRCc7XHJcbiAgICAgIGliYW46IHN0cmluZztcclxuICAgIH1cclxuICB8IHtcclxuICAgICAgLyoqXHJcbiAgICAgICAqIGluIHF1ZXN0byBjYXNvIMOoIGludXRpbGUsIGJhc3RhIGNoZSBub24gcGFzc28gbOKAmWliYW5cclxuICAgICAgICovXHJcbiAgICAgIGNoZWNrVHlwZXM6ICdDUkVESVQnO1xyXG4gICAgICBpYmFuPzogbmV2ZXI7XHJcbiAgICB9O1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDcmVkaXRDaGVja1Jlc3VsdCB7XHJcbiAgY3VzdG9tZXJJbldoaXRlbGlzdDogYm9vbGVhbjtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hDcmVkaXRDaGVjayhcclxuICBwYXlsb2FkOiBDcmVkaXRDaGVja0Jhc2VJbnB1dCAmXHJcbiAgICBDcmVkaXRDaGVja0N1c3RvbWVySW5wdXQgJlxyXG4gICAgQ3JlZGl0Q2hlY2tEYXRhSW5wdXRcclxuKTogUHJvbWlzZTxDcmVkaXRDaGVja1Jlc3VsdD4ge1xyXG4gIGlmIChhcmVDaGVja0J5cGFzc2VkKCkpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGN1c3RvbWVySW5XaGl0ZWxpc3Q6IHRydWUsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgY29uc3QgbG9nSGFzaCA9IGdlbmVyYXRlT3BlcmF0aW9uSUQoKTtcclxuXHJcbiAgY29uc3QgZGF0YTE6IGFueSA9IHtcclxuICAgIGNhbGxlcjogJ1dFQicsXHJcbiAgICBsb2dIYXNoOiBsb2dIYXNoLFxyXG4gICAgcGxpY29Db2RlOiBwYXlsb2FkLnBsaWNvQ29kZSxcclxuICAgIGZpc2NhbENvZGU6IHBheWxvYWQuZmlzY2FsQ29kZSxcclxuICAgIHZhdE51bWJlcjogcGF5bG9hZC52YXROdW1iZXIsXHJcbiAgICBpZExlYWQ6IHBheWxvYWQuaWRMZWFkLFxyXG4gICAgbW9kYWxpdGFPcGVyYXRpdmE6IHBheWxvYWQubW9kYWxpdGFPcGVyYXRpdmEsXHJcbiAgICBjaGVja1R5cGVzOiBwYXlsb2FkLmNoZWNrVHlwZXMsXHJcbiAgfTtcclxuXHJcbiAgaWYgKHBheWxvYWQuY2hlY2tUeXBlcyA9PT0gJ0NSRURJVCxTQ09SRUNBUkQnKSB7XHJcbiAgICBkYXRhMS5pYmFuID0gcGF5bG9hZC5pYmFuO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChcclxuICAgIGAke0FQSX0vd2ViT3JkZXJDb21tb25TZXJ2aWNlcy92MS4xL2NyZWRpdENoZWNrYCxcclxuICAgIHtcclxuICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICAgIEFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24nLFxyXG4gICAgICB9LFxyXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShkYXRhMSksXHJcbiAgICB9XHJcbiAgKTtcclxuXHJcbiAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7XHJcbiAgICB0aHJvdyBuZXcgU2VydmljZVVuaGFuZGxlZFJlc3BvbnNlRXJyb3IoXHJcbiAgICAgIHJlc3BvbnNlLnN0YXR1c1RleHQsXHJcbiAgICAgIGxvZ0hhc2gsXHJcbiAgICAgIHJlc3BvbnNlXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgZGF0YTogV1NPdXRwdXQgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XHJcblxyXG4gIGlmIChcclxuICAgIGRhdGEuZXJyb3JNYW5hZ2VtZW50Py5lcnJvckNvZGUgPT09ICdERExfMDA5JyB8fFxyXG4gICAgZGF0YS5lcnJvck1hbmFnZW1lbnQ/LmVycm9yQ29kZSA9PT0gJ0RETF8wMTAnXHJcbiAgKSB7XHJcbiAgICB0aHJvdyBuZXcgRGRsMDA5XzAxMEVycm9yKFxyXG4gICAgICBkYXRhLmVycm9yTWFuYWdlbWVudD8uZXJyb3JDb2RlLFxyXG4gICAgICBsb2dIYXNoLFxyXG4gICAgICByZXNwb25zZVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGlmIChkYXRhLnN0YXR1cyAhPT0gJ1N1Y2Nlc3MnKSB7XHJcbiAgICB0aHJvdyBuZXcgU2VydmljZVVuaGFuZGxlZFJlc3BvbnNlRXJyb3IoZGF0YS5zdGF0dXMsIGxvZ0hhc2gsIHJlc3BvbnNlKTtcclxuICB9XHJcblxyXG4gIGlmIChkYXRhLnJlc3VsdCAhPT0gJzAwMScpIHtcclxuICAgIHRocm93IG5ldyBTZXJ2aWNlVW5oYW5kbGVkUmVzcG9uc2VFcnJvcihkYXRhLnJlc3VsdCwgbG9nSGFzaCwgcmVzcG9uc2UpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgZXNpdG8gPVxyXG4gICAgY2hlY2tFc2l0byhkYXRhLnJlc3BvbnNlLmNyZWRpdENoZWNrPy5lc2l0bywgKHgpID0+IEpTT04ucGFyc2UoeCkpICYmXHJcbiAgICBjaGVja0VzaXRvKGRhdGEucmVzcG9uc2Uuc2NvcmVjYXJkPy5lc2l0bykgJiZcclxuICAgIGNoZWNrRXNpdG8oZGF0YS5yZXNwb25zZS5pbnNvbHV0b05EUz8uZXNpdG8pO1xyXG5cclxuICBpZiAoIWVzaXRvKSB7XHJcbiAgICB0aHJvdyBuZXcgQ3JlZGl0Q2hlY2tFcnJvcignS09fQ1JFRElUX0NIRUNLJywgbG9nSGFzaCwgcmVzcG9uc2UpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGN1c3RvbWVySW5XaGl0ZWxpc3Q6XHJcbiAgICAgIGRhdGEucmVzcG9uc2UuY3JlZGl0Q2hlY2s/LmRldHRhZ2xpby53aGl0ZWxpc3QgPT09ICdPSycsXHJcbiAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gY2hlY2tFc2l0bzxUPihcclxuICB2OiBULFxyXG4gIHBhcnNlOiAoeDogTm9uTnVsbGFibGU8VD4pID0+IGJvb2xlYW4gPSAoeCkgPT4gISF4XHJcbikge1xyXG4gIC8vIFNlIGwnZXNpdG8gw6ggbnVsbCBvIHVuZGVmaW5lZCBiaXNvZ25hIGFjY2V0dGFybG8gcGVyY2jDqSBpbCBjb250cm9sbG8gaW4gcXVlc3RvIGNhc28gbm9uIMOoIGF2dmVudXRvLlxyXG4gIGlmICh2ID09IG51bGwpIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuICByZXR1cm4gcGFyc2Uodik7XHJcbn1cclxuXHJcbnR5cGUgQ2hlY2tDcmVkaXRNb2RhbGl0YU9wZXJhdGl2YSA9XHJcbiAgfCAnQVRUSVZBWklPTkUnXHJcbiAgfCAnU1dJVENIIElOJ1xyXG4gIHwgJ1ZPTFRVUkEnXHJcbiAgfCAnVk9MVFVSQSBDT04gU1dJVENIJ1xyXG4gIHwgJ0NBTUJJTyBQUk9ET1RUTydcclxuICB8ICdCUk9BREJBTkQgTUlHUkFaSU9ORSdcclxuICB8ICdCUk9BREJBTkQgTlVPVkEgQVRUSVZBWklPTkUnXHJcbiAgfCAnQUxUUk8nO1xyXG5cclxuY29uc3QgZmV0Y2hDcmVkaXRDaGVja0F0b20gPSBhdG9tRmFtaWx5KFxyXG4gICguLi5wYXJhbXM6IFBhcmFtZXRlcnM8dHlwZW9mIGZldGNoQ3JlZGl0Q2hlY2s+KSA9PlxyXG4gICAgYXRvbVdpdGhFcnJvclJlc2V0KCgpID0+IGZldGNoQ3JlZGl0Q2hlY2soLi4ucGFyYW1zKSksXHJcbiAgKGEsIGIpID0+IGRlZXBFcXVhbHMoYSwgYilcclxuKTtcclxuXHJcbmFzeW5jIGZ1bmN0aW9uIF9jaGVja0NyZWRpdChcclxuICBnZXQ6IEdldHRlcixcclxuICBjdXN0b21lciQ6IEFzeW5jQXRvbTxDdXN0b21lcj4sXHJcbiAgcGF5bWVudERhdGE6IFBpY2s8UGF5bWVudERhdGEsICdwYXltZW50VHlwZSQnIHwgJ3BheW1lbnRUb29sJCc+LFxyXG4gIG1vZGFsaXRhT3BlcmF0aXZhOiBDaGVja0NyZWRpdE1vZGFsaXRhT3BlcmF0aXZhXHJcbik6IFByb21pc2U8Q3JlZGl0Q2hlY2tSZXN1bHQ+IHtcclxuICBjb25zdCBjb250cmFjdCA9IGdldChjdXJyZW50Q29udHJhY3RJbmZvQXRvbSk7XHJcbiAgY29uc3QgaWRMZWFkID0gY29udHJhY3QuaWRMZWFkO1xyXG4gIGNvbnN0IHBsaWNvQ29kZSA9IGF3YWl0IGNvbnRyYWN0LnBsaWNvQ29kZTtcclxuICBjb25zdCB2YXRPclRheElkID0gYXdhaXQgZ2V0VmF0T3JUYXhJZChnZXQsIGN1c3RvbWVyJCk7XHJcblxyXG4gIGNvbnN0IHBheW1lbnRUeXBlID0gYXdhaXQgZ2V0KHBheW1lbnREYXRhLnBheW1lbnRUeXBlJCk7XHJcbiAgaWYgKHBheW1lbnRUeXBlID09PSBQYXltZW50LkRPTUlDSUxJQVRJT04pIHtcclxuICAgIGNvbnN0IHRvb2wgPSBhd2FpdCBnZXQocGF5bWVudERhdGEucGF5bWVudFRvb2wkKTtcclxuICAgIGlmICh0b29sID09IG51bGwpIHtcclxuICAgICAgdGhyb3cgbmV3IFByZWNvbmRpdGlvbkZhaWxlZEVycm9yKFxyXG4gICAgICAgICdQYXltZW50IHR5cGUgaXMgZG9taWNpbGlhdGlvbiBidXQgbm8gaWJhbiBpcyBkZWZpbmVkLidcclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBpYmFuID0gdG9vbC5pYmFuO1xyXG4gICAgcmV0dXJuIGdldChcclxuICAgICAgZmV0Y2hDcmVkaXRDaGVja0F0b20oe1xyXG4gICAgICAgIGlkTGVhZCxcclxuICAgICAgICBwbGljb0NvZGUsXHJcbiAgICAgICAgbW9kYWxpdGFPcGVyYXRpdmEsXHJcbiAgICAgICAgY2hlY2tUeXBlczogJ0NSRURJVCxTQ09SRUNBUkQnLFxyXG4gICAgICAgIGliYW46IGliYW4sXHJcbiAgICAgICAgLi4udmF0T3JUYXhJZCxcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gZ2V0KFxyXG4gICAgZmV0Y2hDcmVkaXRDaGVja0F0b20oe1xyXG4gICAgICBpZExlYWQsXHJcbiAgICAgIHBsaWNvQ29kZSxcclxuICAgICAgbW9kYWxpdGFPcGVyYXRpdmEsXHJcbiAgICAgIGNoZWNrVHlwZXM6ICdDUkVESVQnLFxyXG4gICAgICAuLi52YXRPclRheElkLFxyXG4gICAgfSlcclxuICApO1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBnZXRWYXRPclRheElkKFxyXG4gIGdldDogR2V0dGVyLFxyXG4gIGN1c3RvbWVyJDogQXN5bmNBdG9tPEN1c3RvbWVyPlxyXG4pOiBQcm9taXNlPENyZWRpdENoZWNrQ3VzdG9tZXJJbnB1dD4ge1xyXG4gIGNvbnN0IGN1c3RvbWVyID0gYXdhaXQgZ2V0KGN1c3RvbWVyJCk7XHJcbiAgY29uc3QgcHJvZmlsZSA9IGN1c3RvbWVyLnByb2ZpbGU7XHJcbiAgY29uc3Qgc2VnbWVudCA9IGF3YWl0IGdldChjdXN0b21lci5zZWdtZW50KTtcclxuICBjb25zdCB2YXRPclRheElkID1cclxuICAgIHNlZ21lbnQgPT09IFNlZ21lbnQuU01BTExcclxuICAgICAgPyB7IHZhdE51bWJlcjogKGF3YWl0IGdldChwcm9maWxlLnZhdE51bWJlciQpKSEgfVxyXG4gICAgICA6IHsgZmlzY2FsQ29kZTogKGF3YWl0IGdldChwcm9maWxlLnRheElkJCkpISB9O1xyXG4gIGlmICh2YXRPclRheElkLmZpc2NhbENvZGUgPT0gbnVsbCAmJiB2YXRPclRheElkLnZhdE51bWJlciA9PSBudWxsKSB7XHJcbiAgICB0aHJvdyBuZXcgUHJlY29uZGl0aW9uRmFpbGVkRXJyb3IoJ1RheElkIGlzIGVtcHR5Jyk7XHJcbiAgfVxyXG4gIHJldHVybiB2YXRPclRheElkO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgYXRvbVdpdGhDaGVja0NyZWRpdCA9IChcclxuICBjdXN0b21lciQ6IEFzeW5jQXRvbTxDdXN0b21lcj4sXHJcbiAgcGF5bWVudERhdGE6IFBpY2s8UGF5bWVudERhdGEsICdwYXltZW50VHlwZSQnIHwgJ3BheW1lbnRUb29sJCc+XHJcbikgPT5cclxuICBhdG9tV2l0aEVycm9yUmVzZXQ8Q3JlZGl0Q2hlY2tSZXN1bHQ+KGFzeW5jIChnZXQpID0+IHtcclxuICAgIC8vc2Ugc2lhbW8gaW4gdW5hIHZvbHR1cmEgbW9ydGlzIGNhdXNhIHNhbHRpYW1vIGlsIGNyZWRpdENoZWNrXHJcbiAgICBjb25zdCB0cmFuc2ZlclR5cGUgPSBhd2FpdCBnZXQodHJhbnNmZXJUeXBlQXRvbSk7XHJcbiAgICBpZiAodHJhbnNmZXJUeXBlID09PSBUcmFuc2ZlclR5cGUuTU9SVElTX0NBVVNBKSB7XHJcbiAgICAgIC8vIGB0cnVlYCBwZXIgaW5pYmlyZSBsYSBjaGlhbWF0YSBhbCBjaGVjayBNb2RlbGxvIFZvbHR1cmFcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBjdXN0b21lckluV2hpdGVsaXN0OiB0cnVlLFxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gICAgY29uc3Qgc2FsZXNQcm9jZXNzZXMgPSBhd2FpdCBnZXQoY2hlY2tDcmVkaXRTYWxlc1Byb2Nlc3NlcyQpO1xyXG4gICAgY29uc29sZS5kZWJ1ZyhzYWxlc1Byb2Nlc3Nlcyk7XHJcbiAgICBjb25zdCBwcm9taXNlcyA9IHNhbGVzUHJvY2Vzc2VzLm1hcCgobW9kYWxpdGFPcGVyYXRpdmEpID0+XHJcbiAgICAgIF9jaGVja0NyZWRpdChnZXQsIGN1c3RvbWVyJCwgcGF5bWVudERhdGEsIG1vZGFsaXRhT3BlcmF0aXZhKVxyXG4gICAgKTtcclxuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBjdXN0b21lckluV2hpdGVsaXN0OiByZXN1bHRzLnJlZHVjZShcclxuICAgICAgICAocHJldmlvdXNWYWx1ZSwgY3VycmVudFZhbHVlKSA9PlxyXG4gICAgICAgICAgcHJldmlvdXNWYWx1ZSAmJiBjdXJyZW50VmFsdWUuY3VzdG9tZXJJbldoaXRlbGlzdCxcclxuICAgICAgICB0cnVlXHJcbiAgICAgICksXHJcbiAgICB9O1xyXG4gIH0pO1xyXG5cclxuLyoqXHJcbiAqIEF0b20gdGhhdCByZXR1cm5zIGFuIGFycmF5IG9mIHNhbGVzIHByb2Nlc3NlcywgZm9yIGVhY2ggb25lIHdlIHNob3VsZCBjYWxsIHRoZSBjaGVjayBjcmVkaXQgc2VydmljZVxyXG4gKi9cclxuY29uc3QgY2hlY2tDcmVkaXRTYWxlc1Byb2Nlc3NlcyQgPSBhdG9tPFxyXG4gIFByb21pc2U8QXJyYXk8Q2hlY2tDcmVkaXRNb2RhbGl0YU9wZXJhdGl2YT4+XHJcbj4oYXN5bmMgKGdldCkgPT4ge1xyXG4gIGNvbnN0IHdwID0gZ2V0KHdvcmtpbmdQcm9kdWN0QXRvbSk7XHJcbiAgaWYgKHdwID09IG51bGwpIHtcclxuICAgIHJldHVybiBbJ0FMVFJPJ107XHJcbiAgfVxyXG5cclxuICBjb25zdCB0b1JldHVybiA9IG5ldyBTZXQ8Q2hlY2tDcmVkaXRNb2RhbGl0YU9wZXJhdGl2YT4oKTtcclxuICBpZiAod3AuY29tbW9kaXR5KSB7XHJcbiAgICBjb25zdCBtb2RhbGl0YU9wZXJhdGl2YSA9IGdldENoZWNrQ3JlZGl0Q29tbW9kaXR5TW9kYWxpdGFPcGVyYXRpdmEoXHJcbiAgICAgIHdwLm9wZXJhdGl2ZU1vZGVcclxuICAgICk7XHJcbiAgICBpZiAobW9kYWxpdGFPcGVyYXRpdmEpIHtcclxuICAgICAgdG9SZXR1cm4uYWRkKG1vZGFsaXRhT3BlcmF0aXZhKTtcclxuICAgIH1cclxuICB9XHJcbiAgaWYgKHdwLmJyb2FkYmFuZCkge1xyXG4gICAgY29uc3QgYnJvYWRiYW5kID0gYXdhaXQgZ2V0KGJyb2FkYmFuZCQpO1xyXG4gICAgY29uc3QgbW9kYWxpdGFPcGVyYXRpdmEgPSBnZXQoYnJvYWRiYW5kLnNhbGVzUHJvY2VzcyQpO1xyXG4gICAgdG9SZXR1cm4uYWRkKG1vZGFsaXRhT3BlcmF0aXZhKTtcclxuICB9XHJcblxyXG4gIGlmICghdG9SZXR1cm4uc2l6ZSkge1xyXG4gICAgdG9SZXR1cm4uYWRkKCdBTFRSTycpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIFsuLi50b1JldHVybi52YWx1ZXMoKV07XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gZ2V0Q2hlY2tDcmVkaXRDb21tb2RpdHlNb2RhbGl0YU9wZXJhdGl2YShcclxuICBvcGVyYXRpdmVNb2RlOiBPcGVyYXRpdmVNb2RlIHwgdW5kZWZpbmVkXHJcbik6IENoZWNrQ3JlZGl0TW9kYWxpdGFPcGVyYXRpdmEgfCB1bmRlZmluZWQge1xyXG4gIHN3aXRjaCAob3BlcmF0aXZlTW9kZSkge1xyXG4gICAgY2FzZSBPcGVyYXRpdmVNb2RlLlNXSVRDSF9JTjpcclxuICAgICAgcmV0dXJuICdTV0lUQ0ggSU4nO1xyXG4gICAgY2FzZSBPcGVyYXRpdmVNb2RlLlNXSVRDSF9JTl9UUkFOU0ZFUjpcclxuICAgICAgcmV0dXJuICdWT0xUVVJBIENPTiBTV0lUQ0gnO1xyXG4gICAgY2FzZSBPcGVyYXRpdmVNb2RlLlRSQU5TRkVSOlxyXG4gICAgICByZXR1cm4gJ1ZPTFRVUkEnO1xyXG4gICAgY2FzZSBPcGVyYXRpdmVNb2RlLk5FV19BQ1RJVkFUSU9OOlxyXG4gICAgICByZXR1cm4gJ0FUVElWQVpJT05FJztcclxuICAgIGNhc2UgT3BlcmF0aXZlTW9kZS5DSEFOR0VfT0ZGRVI6XHJcbiAgICAgIHJldHVybiAnQ0FNQklPIFBST0RPVFRPJztcclxuICB9XHJcbn1cclxuIl0sImZpbGUiOiJDOi9Vc2Vycy9haW50cm9uYS9EZXNrdG9wL0FwcC9yZWFjdC9uYWovbGlicy9kYXRhLWFjY2Vzcy9zcmMvbGliL2FwaS93ZWJvcmRlci9jcmVkaXRDaGVjay50cyJ9