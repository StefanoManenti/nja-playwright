globalThis.jotaiAtomCache = globalThis.jotaiAtomCache || {
  cache: /* @__PURE__ */ new Map(),
  get(name, inst) {
    if (this.cache.has(name)) {
      return this.cache.get(name);
    }
    this.cache.set(name, inst);
    return inst;
  }
};
export class DependenciesGraph {
  constructor(steps, ...args) {
    this.steps = steps;
    this.providers = /* @__PURE__ */ new Map();
    this.dipendenze = /* @__PURE__ */ new Map();
    this.dipendenti = /* @__PURE__ */ new Map();
    this.populateProviders(...args);
    this.popolateDependencies(...args);
    this.popolateDipendenti();
    console.groupCollapsed("Graph");
    console.debug("providers", this.providers);
    console.debug("dipendenze", this.dipendenze);
    console.debug("dipendenti", this.dipendenti);
    console.groupEnd();
  }
  /**
   * Per lo step passato come parametro, ritorna quali step sono necessari.
   * @param step
   * @private
   */
  getDipendenze(step) {
    return this.dipendenze.get(step);
  }
  /**
   * Ritorna quali step sono dipendenti da questo.
   * @param step
   */
  getDipendenti(step) {
    return this.dipendenti.get(step);
  }
  getDipendentiRicorsivo(step) {
    const daVisitare = [step];
    const visitati = /* @__PURE__ */ new Set();
    let s = daVisitare.pop();
    while (s) {
      visitati.add(s);
      const stepDipendenti = this.dipendenti.get(step);
      if (stepDipendenti) {
        for (const step2 of stepDipendenti) {
          if (!visitati.has(step2)) daVisitare.push(step2);
        }
      }
      s = daVisitare.pop();
    }
    return visitati;
  }
  /**
   * Ritorna quali step non hanno dipendenti
   * @private
   */
  getStepsConZeroDipendenti() {
    return [...this.steps].filter((step) => !this.dipendenti.has(step));
  }
  /**
   * Ritorna tutti gli step
   * @private
   */
  getSteps() {
    return this.steps;
  }
  populateProviders(...args) {
    for (const step of this.steps) {
      for (const provide of step.provides(...args)) {
        const step1 = this.providers.get(provide);
        if (step1 != null) {
          throw Error(`${step1} and ${step} already provides ${provide}`);
        }
        this.providers.set(provide, step);
      }
    }
  }
  popolateDependencies(...args) {
    for (const step of this.steps) {
      const set = /* @__PURE__ */ new Set();
      this.dipendenze.set(step, set);
      for (const depend of step.depends(...args)) {
        const dependency = this.providers.get(depend);
        if (dependency != null) {
          set.add(dependency);
        }
      }
    }
  }
  popolateDipendenti() {
    for (const [step, dependencies] of this.dipendenze.entries()) {
      for (const dependency of dependencies) {
        let steps = this.dipendenti.get(dependency);
        if (steps == null) {
          steps = /* @__PURE__ */ new Set();
          this.dipendenti.set(dependency, steps);
        }
        steps.add(step);
      }
    }
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQVdPLGFBQU1BLGtCQUlYO0FBQUEsRUFLQUMsWUFBc0JDLFVBQTJCQyxNQUFhO0FBQXhDRDtBQUp0QixTQUFpQkUsWUFBWSxvQkFBSUMsSUFBd0I7QUFDekQsU0FBaUJDLGFBQWEsb0JBQUlELElBQXVCO0FBQ3pELFNBQWlCRSxhQUFhLG9CQUFJRixJQUF1QjtBQUd2RCxTQUFLRyxrQkFBa0IsR0FBR0wsSUFBSTtBQUM5QixTQUFLTSxxQkFBcUIsR0FBR04sSUFBSTtBQUNqQyxTQUFLTyxtQkFBbUI7QUFFeEJDLFlBQVFDLGVBQWUsT0FBTztBQUM5QkQsWUFBUUUsTUFBTSxhQUFhLEtBQUtULFNBQVM7QUFDekNPLFlBQVFFLE1BQU0sY0FBYyxLQUFLUCxVQUFVO0FBQzNDSyxZQUFRRSxNQUFNLGNBQWMsS0FBS04sVUFBVTtBQUMzQ0ksWUFBUUcsU0FBUztBQUFBLEVBQ25CO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBT0FDLGNBQWNDLE1BQWE7QUFDekIsV0FBTyxLQUFLVixXQUFXVyxJQUFJRCxJQUFJO0FBQUEsRUFDakM7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEVBTUFFLGNBQWNGLE1BQWE7QUFDekIsV0FBTyxLQUFLVCxXQUFXVSxJQUFJRCxJQUFJO0FBQUEsRUFDakM7QUFBQSxFQUVBRyx1QkFBdUJILE1BQWE7QUFDbEMsVUFBTUksYUFBYSxDQUFDSixJQUFJO0FBQ3hCLFVBQU1LLFdBQVcsb0JBQUlDLElBQVc7QUFFaEMsUUFBSUMsSUFBSUgsV0FBV0ksSUFBSTtBQUN2QixXQUFPRCxHQUFHO0FBQ1JGLGVBQVNJLElBQUlGLENBQUM7QUFDZCxZQUFNRyxpQkFBaUIsS0FBS25CLFdBQVdVLElBQUlELElBQUk7QUFDL0MsVUFBSVUsZ0JBQWdCO0FBQ2xCLG1CQUFXVixTQUFRVSxnQkFBZ0I7QUFDakMsY0FBSSxDQUFDTCxTQUFTTSxJQUFJWCxLQUFJLEVBQUdJLFlBQVdRLEtBQUtaLEtBQUk7QUFBQSxRQUMvQztBQUFBLE1BQ0Y7QUFDQU8sVUFBSUgsV0FBV0ksSUFBSTtBQUFBLElBQ3JCO0FBRUEsV0FBT0g7QUFBQUEsRUFDVDtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsRUFNQVEsNEJBQTRCO0FBQzFCLFdBQU8sQ0FBQyxHQUFHLEtBQUszQixLQUFLLEVBQUU0QixPQUFRZCxVQUFTLENBQUMsS0FBS1QsV0FBV29CLElBQUlYLElBQUksQ0FBQztBQUFBLEVBQ3BFO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQU1BZSxXQUFXO0FBQ1QsV0FBTyxLQUFLN0I7QUFBQUEsRUFDZDtBQUFBLEVBRVFNLHFCQUFxQkwsTUFBYTtBQUN4QyxlQUFXYSxRQUFRLEtBQUtkLE9BQU87QUFDN0IsaUJBQVc4QixXQUFXaEIsS0FBS2lCLFNBQVMsR0FBRzlCLElBQUksR0FBRztBQUM1QyxjQUFNK0IsUUFBUSxLQUFLOUIsVUFBVWEsSUFBSWUsT0FBTztBQUN4QyxZQUFJRSxTQUFTLE1BQU07QUFDakIsZ0JBQU1DLE1BQU0sR0FBR0QsS0FBSyxRQUFRbEIsSUFBSSxxQkFBcUJnQixPQUFPLEVBQUU7QUFBQSxRQUNoRTtBQUNBLGFBQUs1QixVQUFVZ0MsSUFBSUosU0FBU2hCLElBQUk7QUFBQSxNQUNsQztBQUFBLElBQ0Y7QUFBQSxFQUNGO0FBQUEsRUFFUVAsd0JBQXdCTixNQUFhO0FBQzNDLGVBQVdhLFFBQVEsS0FBS2QsT0FBTztBQUM3QixZQUFNa0MsTUFBTSxvQkFBSWQsSUFBVztBQUMzQixXQUFLaEIsV0FBVzhCLElBQUlwQixNQUFNb0IsR0FBRztBQUU3QixpQkFBV0MsVUFBVXJCLEtBQUtzQixRQUFRLEdBQUduQyxJQUFJLEdBQUc7QUFDMUMsY0FBTW9DLGFBQWEsS0FBS25DLFVBQVVhLElBQUlvQixNQUFNO0FBQzVDLFlBQUlFLGNBQWMsTUFBTTtBQUN0QkgsY0FBSVgsSUFBSWMsVUFBVTtBQUFBLFFBQ3BCO0FBQUEsTUFDRjtBQUFBLElBQ0Y7QUFBQSxFQUNGO0FBQUEsRUFFUTdCLHFCQUFxQjtBQUMzQixlQUFXLENBQUNNLE1BQU13QixZQUFZLEtBQUssS0FBS2xDLFdBQVdtQyxRQUFRLEdBQUc7QUFDNUQsaUJBQVdGLGNBQWNDLGNBQWM7QUFDckMsWUFBSXRDLFFBQVEsS0FBS0ssV0FBV1UsSUFBSXNCLFVBQVU7QUFDMUMsWUFBSXJDLFNBQVMsTUFBTTtBQUNqQkEsa0JBQVEsb0JBQUlvQixJQUFJO0FBQ2hCLGVBQUtmLFdBQVc2QixJQUFJRyxZQUFZckMsS0FBSztBQUFBLFFBQ3ZDO0FBQ0FBLGNBQU11QixJQUFJVCxJQUFJO0FBQUEsTUFDaEI7QUFBQSxJQUNGO0FBQUEsRUFDRjtBQUNGIiwibmFtZXMiOlsiRGVwZW5kZW5jaWVzR3JhcGgiLCJjb25zdHJ1Y3RvciIsInN0ZXBzIiwiYXJncyIsInByb3ZpZGVycyIsIk1hcCIsImRpcGVuZGVuemUiLCJkaXBlbmRlbnRpIiwicG9wdWxhdGVQcm92aWRlcnMiLCJwb3BvbGF0ZURlcGVuZGVuY2llcyIsInBvcG9sYXRlRGlwZW5kZW50aSIsImNvbnNvbGUiLCJncm91cENvbGxhcHNlZCIsImRlYnVnIiwiZ3JvdXBFbmQiLCJnZXREaXBlbmRlbnplIiwic3RlcCIsImdldCIsImdldERpcGVuZGVudGkiLCJnZXREaXBlbmRlbnRpUmljb3JzaXZvIiwiZGFWaXNpdGFyZSIsInZpc2l0YXRpIiwiU2V0IiwicyIsInBvcCIsImFkZCIsInN0ZXBEaXBlbmRlbnRpIiwiaGFzIiwicHVzaCIsImdldFN0ZXBzQ29uWmVyb0RpcGVuZGVudGkiLCJmaWx0ZXIiLCJnZXRTdGVwcyIsInByb3ZpZGUiLCJwcm92aWRlcyIsInN0ZXAxIiwiRXJyb3IiLCJzZXQiLCJkZXBlbmQiLCJkZXBlbmRzIiwiZGVwZW5kZW5jeSIsImRlcGVuZGVuY2llcyIsImVudHJpZXMiXSwiaWdub3JlTGlzdCI6W10sInNvdXJjZXMiOlsiRGVwZW5kZW5jaWVzR3JhcGgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGludGVyZmFjZSBEZXBlbmRlbmNpZXNHcmFwaE5vZGU8XHJcbiAgVERlcGVuZGVuY3ksXHJcbiAgVEFyZ3MgZXh0ZW5kcyB1bmtub3duW10gPSBbXVxyXG4+IHtcclxuICBwcm92aWRlcyguLi5hcmdzOiBUQXJncyk6IFREZXBlbmRlbmN5W107XHJcblxyXG4gIGRlcGVuZHMoLi4uYXJnczogVEFyZ3MpOiBURGVwZW5kZW5jeVtdO1xyXG5cclxuICBkZXBlbmRzKC4uLmFyZ3M6IFRBcmdzKTogVERlcGVuZGVuY3lbXTtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIERlcGVuZGVuY2llc0dyYXBoPFxyXG4gIFREZXBlbmRlbmN5LFxyXG4gIFROb2RlIGV4dGVuZHMgRGVwZW5kZW5jaWVzR3JhcGhOb2RlPFREZXBlbmRlbmN5LCBUQXJncz4sXHJcbiAgVEFyZ3MgZXh0ZW5kcyB1bmtub3duW10gPSBbXVxyXG4+IHtcclxuICBwcml2YXRlIHJlYWRvbmx5IHByb3ZpZGVycyA9IG5ldyBNYXA8VERlcGVuZGVuY3ksIFROb2RlPigpO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgZGlwZW5kZW56ZSA9IG5ldyBNYXA8VE5vZGUsIFNldDxUTm9kZT4+KCk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBkaXBlbmRlbnRpID0gbmV3IE1hcDxUTm9kZSwgU2V0PFROb2RlPj4oKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIHN0ZXBzOiBJdGVyYWJsZTxUTm9kZT4sIC4uLmFyZ3M6IFRBcmdzKSB7XHJcbiAgICB0aGlzLnBvcHVsYXRlUHJvdmlkZXJzKC4uLmFyZ3MpO1xyXG4gICAgdGhpcy5wb3BvbGF0ZURlcGVuZGVuY2llcyguLi5hcmdzKTtcclxuICAgIHRoaXMucG9wb2xhdGVEaXBlbmRlbnRpKCk7XHJcblxyXG4gICAgY29uc29sZS5ncm91cENvbGxhcHNlZCgnR3JhcGgnKTtcclxuICAgIGNvbnNvbGUuZGVidWcoJ3Byb3ZpZGVycycsIHRoaXMucHJvdmlkZXJzKTtcclxuICAgIGNvbnNvbGUuZGVidWcoJ2RpcGVuZGVuemUnLCB0aGlzLmRpcGVuZGVuemUpO1xyXG4gICAgY29uc29sZS5kZWJ1ZygnZGlwZW5kZW50aScsIHRoaXMuZGlwZW5kZW50aSk7XHJcbiAgICBjb25zb2xlLmdyb3VwRW5kKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBQZXIgbG8gc3RlcCBwYXNzYXRvIGNvbWUgcGFyYW1ldHJvLCByaXRvcm5hIHF1YWxpIHN0ZXAgc29ubyBuZWNlc3NhcmkuXHJcbiAgICogQHBhcmFtIHN0ZXBcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIGdldERpcGVuZGVuemUoc3RlcDogVE5vZGUpIHtcclxuICAgIHJldHVybiB0aGlzLmRpcGVuZGVuemUuZ2V0KHN0ZXApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUml0b3JuYSBxdWFsaSBzdGVwIHNvbm8gZGlwZW5kZW50aSBkYSBxdWVzdG8uXHJcbiAgICogQHBhcmFtIHN0ZXBcclxuICAgKi9cclxuICBnZXREaXBlbmRlbnRpKHN0ZXA6IFROb2RlKSB7XHJcbiAgICByZXR1cm4gdGhpcy5kaXBlbmRlbnRpLmdldChzdGVwKTtcclxuICB9XHJcblxyXG4gIGdldERpcGVuZGVudGlSaWNvcnNpdm8oc3RlcDogVE5vZGUpIHtcclxuICAgIGNvbnN0IGRhVmlzaXRhcmUgPSBbc3RlcF07XHJcbiAgICBjb25zdCB2aXNpdGF0aSA9IG5ldyBTZXQ8VE5vZGU+KCk7XHJcblxyXG4gICAgbGV0IHMgPSBkYVZpc2l0YXJlLnBvcCgpO1xyXG4gICAgd2hpbGUgKHMpIHtcclxuICAgICAgdmlzaXRhdGkuYWRkKHMpO1xyXG4gICAgICBjb25zdCBzdGVwRGlwZW5kZW50aSA9IHRoaXMuZGlwZW5kZW50aS5nZXQoc3RlcCk7XHJcbiAgICAgIGlmIChzdGVwRGlwZW5kZW50aSkge1xyXG4gICAgICAgIGZvciAoY29uc3Qgc3RlcCBvZiBzdGVwRGlwZW5kZW50aSkge1xyXG4gICAgICAgICAgaWYgKCF2aXNpdGF0aS5oYXMoc3RlcCkpIGRhVmlzaXRhcmUucHVzaChzdGVwKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcyA9IGRhVmlzaXRhcmUucG9wKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHZpc2l0YXRpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUml0b3JuYSBxdWFsaSBzdGVwIG5vbiBoYW5ubyBkaXBlbmRlbnRpXHJcbiAgICogQHByaXZhdGVcclxuICAgKi9cclxuICBnZXRTdGVwc0Nvblplcm9EaXBlbmRlbnRpKCkge1xyXG4gICAgcmV0dXJuIFsuLi50aGlzLnN0ZXBzXS5maWx0ZXIoKHN0ZXApID0+ICF0aGlzLmRpcGVuZGVudGkuaGFzKHN0ZXApKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJpdG9ybmEgdHV0dGkgZ2xpIHN0ZXBcclxuICAgKiBAcHJpdmF0ZVxyXG4gICAqL1xyXG4gIGdldFN0ZXBzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuc3RlcHM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBvcHVsYXRlUHJvdmlkZXJzKC4uLmFyZ3M6IFRBcmdzKSB7XHJcbiAgICBmb3IgKGNvbnN0IHN0ZXAgb2YgdGhpcy5zdGVwcykge1xyXG4gICAgICBmb3IgKGNvbnN0IHByb3ZpZGUgb2Ygc3RlcC5wcm92aWRlcyguLi5hcmdzKSkge1xyXG4gICAgICAgIGNvbnN0IHN0ZXAxID0gdGhpcy5wcm92aWRlcnMuZ2V0KHByb3ZpZGUpO1xyXG4gICAgICAgIGlmIChzdGVwMSAhPSBudWxsKSB7XHJcbiAgICAgICAgICB0aHJvdyBFcnJvcihgJHtzdGVwMX0gYW5kICR7c3RlcH0gYWxyZWFkeSBwcm92aWRlcyAke3Byb3ZpZGV9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMucHJvdmlkZXJzLnNldChwcm92aWRlLCBzdGVwKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwb3BvbGF0ZURlcGVuZGVuY2llcyguLi5hcmdzOiBUQXJncykge1xyXG4gICAgZm9yIChjb25zdCBzdGVwIG9mIHRoaXMuc3RlcHMpIHtcclxuICAgICAgY29uc3Qgc2V0ID0gbmV3IFNldDxUTm9kZT4oKTtcclxuICAgICAgdGhpcy5kaXBlbmRlbnplLnNldChzdGVwLCBzZXQpO1xyXG5cclxuICAgICAgZm9yIChjb25zdCBkZXBlbmQgb2Ygc3RlcC5kZXBlbmRzKC4uLmFyZ3MpKSB7XHJcbiAgICAgICAgY29uc3QgZGVwZW5kZW5jeSA9IHRoaXMucHJvdmlkZXJzLmdldChkZXBlbmQpO1xyXG4gICAgICAgIGlmIChkZXBlbmRlbmN5ICE9IG51bGwpIHtcclxuICAgICAgICAgIHNldC5hZGQoZGVwZW5kZW5jeSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBvcG9sYXRlRGlwZW5kZW50aSgpIHtcclxuICAgIGZvciAoY29uc3QgW3N0ZXAsIGRlcGVuZGVuY2llc10gb2YgdGhpcy5kaXBlbmRlbnplLmVudHJpZXMoKSkge1xyXG4gICAgICBmb3IgKGNvbnN0IGRlcGVuZGVuY3kgb2YgZGVwZW5kZW5jaWVzKSB7XHJcbiAgICAgICAgbGV0IHN0ZXBzID0gdGhpcy5kaXBlbmRlbnRpLmdldChkZXBlbmRlbmN5KTtcclxuICAgICAgICBpZiAoc3RlcHMgPT0gbnVsbCkge1xyXG4gICAgICAgICAgc3RlcHMgPSBuZXcgU2V0KCk7XHJcbiAgICAgICAgICB0aGlzLmRpcGVuZGVudGkuc2V0KGRlcGVuZGVuY3ksIHN0ZXBzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3RlcHMuYWRkKHN0ZXApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdLCJmaWxlIjoiQzovVXNlcnMvYWludHJvbmEvRGVza3RvcC9BcHAvcmVhY3QvbmFqL2xpYnMvZW5naW5lL3NyYy9saWIvRGVwZW5kZW5jaWVzR3JhcGgudHMifQ==