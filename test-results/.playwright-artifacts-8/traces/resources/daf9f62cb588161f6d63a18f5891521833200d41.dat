globalThis.jotaiAtomCache = globalThis.jotaiAtomCache || {
  cache: /* @__PURE__ */ new Map(),
  get(name, inst) {
    if (this.cache.has(name)) {
      return this.cache.get(name);
    }
    this.cache.set(name, inst);
    return inst;
  }
};
const MUL_PRECISION = 100;
export function mf(price, multiplyWith = 1, digits = 4) {
  if (!price) {
    return "";
  }
  const digitsMul = Math.pow(10, digits);
  const percent = multiplyWith * MUL_PRECISION;
  const s = Number(price.replace(",", "."));
  const calcAndRound = Number(Math.round(Math.round(s * digitsMul * percent) / MUL_PRECISION));
  return (calcAndRound / digitsMul).toFixed(digits).replace(".", ",").replace(/,0+$/, "");
}
export function sf(price, subtractWith, digits = 4) {
  if (!price) {
    return "";
  }
  const digitsMul = Math.pow(10, digits);
  const s = Number(price.replace(",", "."));
  const s2 = Number(`${subtractWith}`.replace(",", "."));
  const calcAndRound = Number(Math.round(s * digitsMul - s2 * digitsMul));
  return (calcAndRound / digitsMul).toFixed(digits).replace(".", ",");
}
export function pricesSum(price, sumWith, digits = 4) {
  if (!price) {
    return "";
  }
  const digitsMul = Math.pow(10, digits);
  const s = Number(price.replace(",", "."));
  const s2 = Number(`${sumWith}`.replace(",", "."));
  const calcAndRound = Number(Math.round(s * digitsMul + s2 * digitsMul));
  return (calcAndRound / digitsMul).toFixed(digits).replace(".", ",");
}
const FULL_PERCENTAGE = 100;
export function applicaSconto(price, sconto, newPrice) {
  if (price.type !== "normal") return price;
  const basePrice = price;
  const sconti = typeof sconto === "function" ? sconto(basePrice) : sconto;
  const price0 = mf(basePrice.qty, 1 - sconti[0] / FULL_PERCENTAGE);
  const price1 = mf(basePrice.qty, 1 - sconti[1] / FULL_PERCENTAGE);
  return newPrice(basePrice, [price0, price1]);
}
export class PriceCalculatorV2 {
  /**
   * @param special Abilita il parsing dei prezzi special. (SPECIAL|PIENO)
   *   Se false ignorerà il prezzo SPECIAL e userà sempre il prezzo PIENO.
   */
  constructor(special = false) {
    this.special = special;
    // Operazioni da applicare
    this.ops = [];
  }
  addDiscount(op) {
    this.ops.push(op);
    return this;
  }
  setTag(tag) {
    this.ops.push({
      tag,
      condition: false
    });
    return this;
  }
  /**
   * Applica gli sconti
   * @param price prezzo preso dal fragment, eventualmente con pipe (SPECIAL|PIENO).
   */
  apply(price) {
    if (price == null) {
      return {
        qty: "ND",
        oldQty: void 0
      };
    }
    const currentCalculator = new SinglePriceCalculator(this.ops);
    const oldCalculator = new SinglePriceCalculator(this.ops.map(PriceCalculatorV2.opForOldPrice));
    const {
      qty,
      fullQty
    } = getQtyAndFullQty(price, this.special);
    return {
      qty: currentCalculator.apply(qty, fullQty),
      oldQty: fullQty ? oldCalculator.apply(fullQty) : void 0
    };
  }
  static opForOldPrice(op) {
    return op.applyAlsoToOldPrice ? op : {
      ...op,
      condition: false
    };
  }
}
class Prices {
  constructor() {
    this.tags = /* @__PURE__ */ new Map();
  }
  get(tag) {
    const p = this.tags.get(tag);
    if (p == null) {
      throw new Error("Unknown tag");
    }
    return p;
  }
  set(tag, value) {
    if (this.tags.has(tag)) {
      throw new Error("Tag already exists");
    }
    this.tags.set(tag, value);
  }
}
class SinglePriceCalculator {
  constructor(ops) {
    this.ops = ops;
  }
  /**
   * Applica gli sconti
   * @param qty prezzo
   * @param fullQty eventuale prezzo originale, se non passato allora `qty` sarà il prezzo originale.
   */
  apply(qty, fullQty) {
    if (qty == null) {
      return qty;
    }
    const tags = new Prices();
    tags.set("original", fullQty ?? qty);
    tags.set("special", qty);
    for (const op of this.ops) {
      qty = this.getOperationFunction(op)(qty, tags);
      if (op.tag) {
        tags.set(op.tag, qty);
      }
    }
    return qty;
  }
  getOperationFunction(op) {
    const transparent = (qty) => qty;
    if (!op.condition) {
      return transparent;
    }
    if ("percent" in op) {
      const {
        percent,
        from,
        digits
      } = op;
      if (percent == null) {
        return transparent;
      }
      return (qty, tags) => {
        return sf(qty, mf(tags.get(from), +percent / 100, digits));
      };
    }
    if ("amount" in op) {
      const {
        amount,
        digits
      } = op;
      if (amount == null) {
        return transparent;
      }
      return (qty) => sf(qty, amount, digits);
    }
    if ("custom" in op) {
      return op.custom;
    }
    throw new Error("Invalid operation");
  }
}
function getQtyAndFullQty(price, enableDiscount) {
  const {
    qty,
    fullQty
  } = parsePriceWithPipe(price);
  if (enableDiscount) {
    return {
      qty,
      fullQty
    };
  } else {
    return {
      qty: fullQty || qty
    };
  }
}
function parsePriceWithPipe(price) {
  let qty = price;
  let fullQty = void 0;
  if (qty?.includes("|")) {
    const split = qty.split("|");
    fullQty = split[1];
    qty = split[0];
  }
  return {
    qty,
    fullQty
  };
}

//# sourceMappingURL=data:application/json;base64,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K0I7QUFDM0IsVUFBSTRCLFVBQVUsTUFBTTtBQUNsQixlQUFPRjtBQUFBQSxNQUNUO0FBQ0EsYUFBTyxDQUFDakMsUUFBZ0JiLEdBQUdhLEtBQUttQyxRQUFRM0QsTUFBTTtBQUFBLElBQ2hEO0FBQ0EsUUFBSSxZQUFZK0IsSUFBSTtBQUNsQixhQUFPQSxHQUFHNkI7QUFBQUEsSUFDWjtBQUNBLFVBQU0sSUFBSVIsTUFBTSxtQkFBbUI7QUFBQSxFQUNyQztBQUNGO0FBU0EsU0FBU1AsaUJBQ1AvQyxPQUNBK0QsZ0JBQ2lFO0FBQ2pFLFFBQU07QUFBQSxJQUFFckM7QUFBQUEsSUFBS29CO0FBQUFBLEVBQVEsSUFBSWtCLG1CQUFtQmhFLEtBQUs7QUFDakQsTUFBSStELGdCQUFnQjtBQUNsQixXQUFPO0FBQUEsTUFBRXJDO0FBQUFBLE1BQUtvQjtBQUFBQSxJQUFRO0FBQUEsRUFDeEIsT0FBTztBQUNMLFdBQU87QUFBQSxNQUFFcEIsS0FBS29CLFdBQVdwQjtBQUFBQSxJQUFJO0FBQUEsRUFDL0I7QUFDRjtBQU1BLFNBQVNzQyxtQkFBbUJoRSxPQUFlO0FBQ3pDLE1BQUkwQixNQUFNMUI7QUFDVixNQUFJOEMsVUFBOEJOO0FBRWxDLE1BQUlkLEtBQUt1QyxTQUFTLEdBQUcsR0FBRztBQUN0QixVQUFNQyxRQUFReEMsSUFBSXdDLE1BQU0sR0FBRztBQUMzQnBCLGNBQVVvQixNQUFNLENBQUM7QUFDakJ4QyxVQUFNd0MsTUFBTSxDQUFDO0FBQUEsRUFDZjtBQUVBLFNBQU87QUFBQSxJQUFFeEM7QUFBQUEsSUFBS29CO0FBQUFBLEVBQVE7QUFDeEIiLCJuYW1lcyI6WyJNVUxfUFJFQ0lTSU9OIiwibWYiLCJwcmljZSIsIm11bHRpcGx5V2l0aCIsImRpZ2l0cyIsImRpZ2l0c011bCIsIk1hdGgiLCJwb3ciLCJwZXJjZW50IiwicyIsIk51bWJlciIsInJlcGxhY2UiLCJjYWxjQW5kUm91bmQiLCJyb3VuZCIsInRvRml4ZWQiLCJzZiIsInN1YnRyYWN0V2l0aCIsInMyIiwicHJpY2VzU3VtIiwic3VtV2l0aCIsIkZVTExfUEVSQ0VOVEFHRSIsImFwcGxpY2FTY29udG8iLCJzY29udG8iLCJuZXdQcmljZSIsInR5cGUiLCJiYXNlUHJpY2UiLCJzY29udGkiLCJwcmljZTAiLCJxdHkiLCJwcmljZTEiLCJQcmljZUNhbGN1bGF0b3JWMiIsImNvbnN0cnVjdG9yIiwic3BlY2lhbCIsIm9wcyIsImFkZERpc2NvdW50Iiwib3AiLCJwdXNoIiwic2V0VGFnIiwidGFnIiwiY29uZGl0aW9uIiwiYXBwbHkiLCJvbGRRdHkiLCJ1bmRlZmluZWQiLCJjdXJyZW50Q2FsY3VsYXRvciIsIlNpbmdsZVByaWNlQ2FsY3VsYXRvciIsIm9sZENhbGN1bGF0b3IiLCJtYXAiLCJvcEZvck9sZFByaWNlIiwiZnVsbFF0eSIsImdldFF0eUFuZEZ1bGxRdHkiLCJhcHBseUFsc29Ub09sZFByaWNlIiwiUHJpY2VzIiwidGFncyIsIk1hcCIsImdldCIsInAiLCJFcnJvciIsInNldCIsInZhbHVlIiwiaGFzIiwiZ2V0T3BlcmF0aW9uRnVuY3Rpb24iLCJ0cmFuc3BhcmVudCIsImZyb20iLCJhbW91bnQiLCJjdXN0b20iLCJlbmFibGVEaXNjb3VudCIsInBhcnNlUHJpY2VXaXRoUGlwZSIsImluY2x1ZGVzIiwic3BsaXQiXSwiaWdub3JlTGlzdCI6W10sInNvdXJjZXMiOlsidXRpbHMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUHJpY2UsIFByaWNlTm9ybWFsIH0gZnJvbSAnLi9wcmljZXMnO1xyXG5cclxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1tYWdpYy1udW1iZXJzXHJcbmNvbnN0IE1VTF9QUkVDSVNJT04gPSAxMDA7XHJcblxyXG4vKipcclxuICogVGhpcyBzdHJhbmdlIGNhbGN1bGF0aW9uIGlzIGZvciBwcmV2ZW50IHJvdW5kaW5nIGVycm9yXHJcbiAqIEBwYXJhbSBwcmljZVxyXG4gKiBAcGFyYW0gbXVsdGlwbHlXaXRoXHJcbiAqIEBwYXJhbSBkaWdpdHMgcHJlY2lzaW9uIGRpZ2l0c1xyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIG1mKFxyXG4gIHByaWNlOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsIHwgZmFsc2UgfCAnJyxcclxuICBtdWx0aXBseVdpdGggPSAxLFxyXG4gIGRpZ2l0cyA9IDRcclxuKSB7XHJcbiAgaWYgKCFwcmljZSkge1xyXG4gICAgcmV0dXJuICcnO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgZGlnaXRzTXVsID0gTWF0aC5wb3coMTAsIGRpZ2l0cyk7XHJcblxyXG4gIGNvbnN0IHBlcmNlbnQgPSBtdWx0aXBseVdpdGggKiBNVUxfUFJFQ0lTSU9OO1xyXG5cclxuICBjb25zdCBzID0gTnVtYmVyKHByaWNlLnJlcGxhY2UoJywnLCAnLicpKTtcclxuXHJcbiAgY29uc3QgY2FsY0FuZFJvdW5kID0gTnVtYmVyKFxyXG4gICAgTWF0aC5yb3VuZChNYXRoLnJvdW5kKHMgKiBkaWdpdHNNdWwgKiBwZXJjZW50KSAvIE1VTF9QUkVDSVNJT04pXHJcbiAgKTtcclxuXHJcbiAgcmV0dXJuIChjYWxjQW5kUm91bmQgLyBkaWdpdHNNdWwpXHJcbiAgICAudG9GaXhlZChkaWdpdHMpXHJcbiAgICAucmVwbGFjZSgnLicsICcsJylcclxuICAgIC5yZXBsYWNlKC8sMCskLywgJycpO1xyXG59XHJcblxyXG4vKipcclxuICogVGhpcyBzdHJhbmdlIGNhbGN1bGF0aW9uIGlzIGZvciBwcmV2ZW50IHJvdW5kaW5nIGVycm9yXHJcbiAqIEBwYXJhbSBwcmljZSBwcmV6em8gZGEgc2NvbnRhcmVcclxuICogQHBhcmFtIHN1YnRyYWN0V2l0aCBzb3R0cmFlIHByaWNlIHBlciBxdWVzdG8gdmFsb3JlXHJcbiAqIEBwYXJhbSBkaWdpdHMgcHJlY2lzaW9uIGRpZ2l0c1xyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHNmKFxyXG4gIHByaWNlOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsIHwgZmFsc2UgfCAnJyxcclxuICBzdWJ0cmFjdFdpdGg6IHN0cmluZyB8IG51bWJlcixcclxuICBkaWdpdHMgPSA0XHJcbikge1xyXG4gIGlmICghcHJpY2UpIHtcclxuICAgIHJldHVybiAnJztcclxuICB9XHJcblxyXG4gIGNvbnN0IGRpZ2l0c011bCA9IE1hdGgucG93KDEwLCBkaWdpdHMpO1xyXG5cclxuICBjb25zdCBzID0gTnVtYmVyKHByaWNlLnJlcGxhY2UoJywnLCAnLicpKTtcclxuICBjb25zdCBzMiA9IE51bWJlcihgJHtzdWJ0cmFjdFdpdGh9YC5yZXBsYWNlKCcsJywgJy4nKSk7XHJcblxyXG4gIGNvbnN0IGNhbGNBbmRSb3VuZCA9IE51bWJlcihNYXRoLnJvdW5kKHMgKiBkaWdpdHNNdWwgLSBzMiAqIGRpZ2l0c011bCkpO1xyXG5cclxuICByZXR1cm4gKGNhbGNBbmRSb3VuZCAvIGRpZ2l0c011bCkudG9GaXhlZChkaWdpdHMpLnJlcGxhY2UoJy4nLCAnLCcpO1xyXG59XHJcblxyXG4vKipcclxuICogVGhpcyBzdHJhbmdlIGNhbGN1bGF0aW9uIGlzIGZvciBwcmV2ZW50IHJvdW5kaW5nIGVycm9yXHJcbiAqIEBwYXJhbSBwcmljZSBwcmV6em8gZGEgc2NvbnRhcmVcclxuICogQHBhcmFtIHN1bVdpdGggc29tbWEgcHJpY2UgcGVyIHF1ZXN0byB2YWxvcmVcclxuICogQHBhcmFtIGRpZ2l0cyBwcmVjaXNpb24gZGlnaXRzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gcHJpY2VzU3VtKFxyXG4gIHByaWNlOiBzdHJpbmcgfCB1bmRlZmluZWQgfCBudWxsIHwgZmFsc2UgfCAnJyxcclxuICBzdW1XaXRoOiBzdHJpbmcgfCBudW1iZXIsXHJcbiAgZGlnaXRzID0gNFxyXG4pIHtcclxuICBpZiAoIXByaWNlKSB7XHJcbiAgICByZXR1cm4gJyc7XHJcbiAgfVxyXG5cclxuICBjb25zdCBkaWdpdHNNdWwgPSBNYXRoLnBvdygxMCwgZGlnaXRzKTtcclxuXHJcbiAgY29uc3QgcyA9IE51bWJlcihwcmljZS5yZXBsYWNlKCcsJywgJy4nKSk7XHJcbiAgY29uc3QgczIgPSBOdW1iZXIoYCR7c3VtV2l0aH1gLnJlcGxhY2UoJywnLCAnLicpKTtcclxuXHJcbiAgY29uc3QgY2FsY0FuZFJvdW5kID0gTnVtYmVyKE1hdGgucm91bmQocyAqIGRpZ2l0c011bCArIHMyICogZGlnaXRzTXVsKSk7XHJcblxyXG4gIHJldHVybiAoY2FsY0FuZFJvdW5kIC8gZGlnaXRzTXVsKS50b0ZpeGVkKGRpZ2l0cykucmVwbGFjZSgnLicsICcsJyk7XHJcbn1cclxuXHJcbmNvbnN0IEZVTExfUEVSQ0VOVEFHRSA9IDEwMDtcclxuXHJcbi8qKlxyXG4gKiBBcHBsaWNhIGdsaSBzY29udGkgYSB1biBvZ2dldHRvIFJvd1xyXG4gKiBAcGFyYW0gcHJpY2UgLSBPZ2dldHRvIFByaWNlIGRhIHNjb250YXJlXHJcbiAqIEBwYXJhbSBzY29udG8gLSB0dXBsYSBkaSBkdWUgZWxlbWVudGkgY29udGVuZW50ZSBzY29udG8gaW4gYWx0byBlIHNjb250byBpbiBiYXNzb1xyXG4gKiBAcGFyYW0gbmV3UHJpY2UgLSBudW92byBvZ2dldHRvIFJvdyBhIHBhcnRpcmUgZGFsIFJvdyB2ZWNjaGlvIGUgaSBkdWUgcHJlenppIHNjb250YXRpIGNhbGNvbGF0aVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGFwcGxpY2FTY29udG8oXHJcbiAgcHJpY2U6IFByaWNlLFxyXG4gIHNjb250bzogW251bWJlciwgbnVtYmVyXSB8ICgoYmFzZVByaWNlOiBQcmljZU5vcm1hbCkgPT4gW251bWJlciwgbnVtYmVyXSksXHJcbiAgbmV3UHJpY2U6IChcclxuICAgIGJhc2VQcmljZTogUHJpY2VOb3JtYWwsXHJcbiAgICBkaXNjb3VudGVkUHJpY2VzOiBbc3RyaW5nLCBzdHJpbmddXHJcbiAgKSA9PiBQcmljZU5vcm1hbFxyXG4pOiBQcmljZSB7XHJcbiAgaWYgKHByaWNlLnR5cGUgIT09ICdub3JtYWwnKSByZXR1cm4gcHJpY2U7XHJcblxyXG4gIGNvbnN0IGJhc2VQcmljZTogUHJpY2VOb3JtYWwgPSBwcmljZTtcclxuICBjb25zdCBzY29udGkgPSB0eXBlb2Ygc2NvbnRvID09PSAnZnVuY3Rpb24nID8gc2NvbnRvKGJhc2VQcmljZSkgOiBzY29udG87XHJcbiAgY29uc3QgcHJpY2UwID0gbWYoYmFzZVByaWNlLnF0eSwgMSAtIHNjb250aVswXSAvIEZVTExfUEVSQ0VOVEFHRSk7XHJcbiAgY29uc3QgcHJpY2UxID0gbWYoYmFzZVByaWNlLnF0eSwgMSAtIHNjb250aVsxXSAvIEZVTExfUEVSQ0VOVEFHRSk7XHJcblxyXG4gIHJldHVybiBuZXdQcmljZShiYXNlUHJpY2UsIFtwcmljZTAsIHByaWNlMV0pO1xyXG59XHJcblxyXG50eXBlIE9wZXJhdGlvbjxUYWc+ID0ge1xyXG4gIC8qKlxyXG4gICAqIEFzc2VnbmEgdW4gdGFnIGFsIG51b3ZvIHByZXp6byBjYWxjb2xhdG8uXHJcbiAgICogU2UgY29uZGl0aW9uIMOoIGBmYWxzZWAgYXNzZWduZXLDoCBsJ3VsdGltbyBwcmV6em8gY2FsY29sYXRvIGRpc3BvbmliaWxlIChjb21lIHNlIGxvIHNjb250byBmb3NzZSBkZWxsbyAwJSkuXHJcbiAgICovXHJcbiAgdGFnPzogVGFnO1xyXG4gIC8vIElmIGZhbHNlIGRvZXMgbm90IGFwcGx5IHRoaXMgb3BlcmF0aW9uLiBTYW1lIGFzIGRpc2NvdW50IG9mIDAlO1xyXG4gIGNvbmRpdGlvbjogYm9vbGVhbjtcclxuICAvLyBJZiB0cnVlLCBhcHBseSBkaXNjb3VudCBhbHNvIHRvIG9sZCBwcmljZS5cclxuICBhcHBseUFsc29Ub09sZFByaWNlPzogYm9vbGVhbjtcclxufSAmIChcclxuICB8IHtcclxuICAgICAgY29uZGl0aW9uOiBmYWxzZTtcclxuICAgIH1cclxuICB8IHtcclxuICAgICAgY29uZGl0aW9uOiBib29sZWFuO1xyXG4gICAgICBwZXJjZW50OiBzdHJpbmcgfCBudW1iZXIgfCBudWxsIHwgdW5kZWZpbmVkO1xyXG4gICAgICAvKipcclxuICAgICAgICogLSBcIm9yaWdpbmFsXCIgcGVyIGlsIHByZXp6byBvcmlnaW5hbGUsIHF1ZWxsbyBwaWVuby5cclxuICAgICAgICogLSBcInNwZWNpYWxcIiBwZXIgbCdldmVudHVhbGUgcHJlenpvIHNjb250YXRvIHJpY2V2dXRvIGRhbCBmcmFnbWVudC5cclxuICAgICAgICogb3BwdXJlIHVuIHRhZyBhc3NlZ25hdG8gcHJlY2VkZW50ZW1lbnRlXHJcbiAgICAgICAqL1xyXG4gICAgICBmcm9tOiBUYWc7XHJcbiAgICAgIGRpZ2l0cz86IG51bWJlcjtcclxuICAgIH1cclxuICB8IHtcclxuICAgICAgY29uZGl0aW9uOiBib29sZWFuO1xyXG4gICAgICBhbW91bnQ6IHN0cmluZyB8IG51bWJlciB8IG51bGwgfCB1bmRlZmluZWQ7XHJcbiAgICAgIGRpZ2l0cz86IG51bWJlcjtcclxuICAgIH1cclxuICB8IHtcclxuICAgICAgY29uZGl0aW9uOiBib29sZWFuO1xyXG4gICAgICBjdXN0b206IChxdHk6IHN0cmluZykgPT4gc3RyaW5nO1xyXG4gICAgfVxyXG4pO1xyXG5cclxuLyoqXHJcbiAqIE51b3ZvIGNhbGNvbGF0b3JlIHByZXp6aSxcclxuICogc3VwcG9ydGEgbCdhcHBsaWNhemlvbmUgZGkgc2NvbnRpIHBlcmNlbnR1YWxpIHNlbGV6aW9uYW5kbyBxdWFsIMOoIGlsIHByZXp6byBiYXNlIGRhIHNjb250YXJlLlxyXG4gKlxyXG4gKiAjIyBTY29udG8gZmlzc29cclxuICogRGltaW51aXNjZSBpbCBwcmV6em8gY29ycmVudGUgcGVyIHVuYSBxdWFudGl0w6AgZmlzc2EuXHJcbiAqXHJcbiAqICMjIFNjb250byBwZXJjZW50dWFsZVxyXG4gKiBEaW1pbnVpc2NlIGlsIHByZXp6byBjb3JyZW50ZSBwZXIgaWwgX19wcmV6em8gYmFzZV9fIG1vbHRpcGxpY2F0byBwZXIgdW5hIHBlcmNlbnR1YWxlLlxyXG4gKiBJbCBfX3ByZXp6byBiYXNlX18gdmllbmUgc2VsZXppb25hdG8gdHJhbWl0ZSB1biBfX3RhZ19fLlxyXG4gKlxyXG4gKiAjIyBTY29udG8gY3VzdG9tXHJcbiAqIExhc2NpYW1vIGxpYmVydMOgIGFsbGEgZmFudGFzaWEgZGVpIHJlZGF0dG9yaSwgY29uIHF1ZXN0byBzY29udG8gY3VzdG9taXp6YXRvIHB1b2kgc2NlZ2xpZXJlIGxhIGZvcm11bGEgZGEgYXBwbGljYXJlIVxyXG4gKlxyXG4gKiAjIFRhZ1xyXG4gKiBJIHRhZyBwZXJtZXR0b25vIGRpIHNhbHZhcmUgb2duaSBwcmV6em8gaW50ZXJtZWRpbywgY29zw6wgaGFpIGxhIG1hc3NpbWEgZmxlc3NpYmlsaXTDoCBuZWwgY2FsY29sYXJlIGdsaSBzY29udGkuXHJcbiAqIElsIHRhZyBcIm9yaWdpbmFsXCIgZSBcInNwZWNpYWxcIiBzb25vIHNlbXByZSBwcmVzZW50aSwgcmFwcHJlc2VudGFubzpcclxuICogLSBcIm9yaWdpbmFsXCIgaWwgcHJlenpvIHBpZW5vLFxyXG4gKiAtIFwic3BlY2lhbFwiIGlsIHByZXp6byBzcGVjaWFsZSwgc2UgYXBwbGljYWJpbGUsIGFsdHJpbWVudGkgw6ggaWwgcHJlenpvIHBpZW5vLlxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIFByaWNlQ2FsY3VsYXRvclYyPFRhZyBleHRlbmRzIHN0cmluZz4ge1xyXG4gIC8vIE9wZXJhemlvbmkgZGEgYXBwbGljYXJlXHJcbiAgcmVhZG9ubHkgb3BzOiBPcGVyYXRpb248VGFnIHwgJ29yaWdpbmFsJyB8ICdzcGVjaWFsJz5bXSA9IFtdO1xyXG5cclxuICAvKipcclxuICAgKiBAcGFyYW0gc3BlY2lhbCBBYmlsaXRhIGlsIHBhcnNpbmcgZGVpIHByZXp6aSBzcGVjaWFsLiAoU1BFQ0lBTHxQSUVOTylcclxuICAgKiAgIFNlIGZhbHNlIGlnbm9yZXLDoCBpbCBwcmV6em8gU1BFQ0lBTCBlIHVzZXLDoCBzZW1wcmUgaWwgcHJlenpvIFBJRU5PLlxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHJlYWRvbmx5IHNwZWNpYWwgPSBmYWxzZSkge31cclxuXHJcbiAgYWRkRGlzY291bnQob3A6IE9wZXJhdGlvbjxUYWcgfCAnb3JpZ2luYWwnIHwgJ3NwZWNpYWwnPikge1xyXG4gICAgdGhpcy5vcHMucHVzaChvcCk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIHNldFRhZyh0YWc6IFRhZykge1xyXG4gICAgdGhpcy5vcHMucHVzaCh7IHRhZywgY29uZGl0aW9uOiBmYWxzZSB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQXBwbGljYSBnbGkgc2NvbnRpXHJcbiAgICogQHBhcmFtIHByaWNlIHByZXp6byBwcmVzbyBkYWwgZnJhZ21lbnQsIGV2ZW50dWFsbWVudGUgY29uIHBpcGUgKFNQRUNJQUx8UElFTk8pLlxyXG4gICAqL1xyXG4gIGFwcGx5KHByaWNlOiBzdHJpbmcpOiB7IHF0eTogc3RyaW5nOyBvbGRRdHk6IHN0cmluZyB8IHVuZGVmaW5lZCB9IHtcclxuICAgIGlmIChwcmljZSA9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiB7IHF0eTogJ05EJywgb2xkUXR5OiB1bmRlZmluZWQgfTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjdXJyZW50Q2FsY3VsYXRvciA9IG5ldyBTaW5nbGVQcmljZUNhbGN1bGF0b3IodGhpcy5vcHMpO1xyXG4gICAgY29uc3Qgb2xkQ2FsY3VsYXRvciA9IG5ldyBTaW5nbGVQcmljZUNhbGN1bGF0b3IoXHJcbiAgICAgIHRoaXMub3BzLm1hcChQcmljZUNhbGN1bGF0b3JWMi5vcEZvck9sZFByaWNlKVxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCB7IHF0eSwgZnVsbFF0eSB9ID0gZ2V0UXR5QW5kRnVsbFF0eShwcmljZSwgdGhpcy5zcGVjaWFsKTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBxdHk6IGN1cnJlbnRDYWxjdWxhdG9yLmFwcGx5KHF0eSwgZnVsbFF0eSksXHJcbiAgICAgIG9sZFF0eTogZnVsbFF0eSA/IG9sZENhbGN1bGF0b3IuYXBwbHkoZnVsbFF0eSkgOiB1bmRlZmluZWQsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdGF0aWMgb3BGb3JPbGRQcmljZTxUYWcgZXh0ZW5kcyBzdHJpbmc+KFxyXG4gICAgb3A6IE9wZXJhdGlvbjxUYWc+XHJcbiAgKTogT3BlcmF0aW9uPFRhZz4ge1xyXG4gICAgcmV0dXJuIG9wLmFwcGx5QWxzb1RvT2xkUHJpY2UgPyBvcCA6IHsgLi4ub3AsIGNvbmRpdGlvbjogZmFsc2UgfTtcclxuICB9XHJcbn1cclxuXHJcbmNsYXNzIFByaWNlczxUYWcgZXh0ZW5kcyBzdHJpbmc+IHtcclxuICBwcml2YXRlIHJlYWRvbmx5IHRhZ3MgPSBuZXcgTWFwPFRhZywgc3RyaW5nPigpO1xyXG4gIGdldCh0YWc6IFRhZykge1xyXG4gICAgY29uc3QgcCA9IHRoaXMudGFncy5nZXQodGFnKTtcclxuICAgIGlmIChwID09IG51bGwpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIHRhZycpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHA7XHJcbiAgfVxyXG4gIHNldCh0YWc6IFRhZywgdmFsdWU6IHN0cmluZykge1xyXG4gICAgaWYgKHRoaXMudGFncy5oYXModGFnKSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RhZyBhbHJlYWR5IGV4aXN0cycpO1xyXG4gICAgfVxyXG4gICAgdGhpcy50YWdzLnNldCh0YWcsIHZhbHVlKTtcclxuICB9XHJcbn1cclxuXHJcbmNsYXNzIFNpbmdsZVByaWNlQ2FsY3VsYXRvcjxUYWcgZXh0ZW5kcyBzdHJpbmc+IHtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3BzOiBPcGVyYXRpb248VGFnIHwgJ29yaWdpbmFsJyB8ICdzcGVjaWFsJz5bXVxyXG4gICkge31cclxuXHJcbiAgLyoqXHJcbiAgICogQXBwbGljYSBnbGkgc2NvbnRpXHJcbiAgICogQHBhcmFtIHF0eSBwcmV6em9cclxuICAgKiBAcGFyYW0gZnVsbFF0eSBldmVudHVhbGUgcHJlenpvIG9yaWdpbmFsZSwgc2Ugbm9uIHBhc3NhdG8gYWxsb3JhIGBxdHlgIHNhcsOgIGlsIHByZXp6byBvcmlnaW5hbGUuXHJcbiAgICovXHJcbiAgYXBwbHkocXR5OiBzdHJpbmcsIGZ1bGxRdHk/OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKHF0eSA9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBxdHk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUGVyIHNhbHZhcmNpIGkgcmlzdWx0YXRpIGRlbGxlIG9wZXJhemlvbmlcclxuICAgIGNvbnN0IHRhZ3MgPSBuZXcgUHJpY2VzPFRhZyB8ICdvcmlnaW5hbCcgfCAnc3BlY2lhbCc+KCk7XHJcbiAgICB0YWdzLnNldCgnb3JpZ2luYWwnLCBmdWxsUXR5ID8/IHF0eSk7XHJcbiAgICB0YWdzLnNldCgnc3BlY2lhbCcsIHF0eSk7XHJcblxyXG4gICAgZm9yIChjb25zdCBvcCBvZiB0aGlzLm9wcykge1xyXG4gICAgICBxdHkgPSB0aGlzLmdldE9wZXJhdGlvbkZ1bmN0aW9uKG9wKShxdHksIHRhZ3MpO1xyXG4gICAgICBpZiAob3AudGFnKSB7XHJcbiAgICAgICAgdGFncy5zZXQob3AudGFnLCBxdHkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHF0eTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0T3BlcmF0aW9uRnVuY3Rpb248VCBleHRlbmRzIHN0cmluZz4oXHJcbiAgICBvcDogT3BlcmF0aW9uPFQ+XHJcbiAgKTogKHF0eTogc3RyaW5nLCB0YWdzOiBQcmljZXM8VD4pID0+IHN0cmluZyB7XHJcbiAgICBjb25zdCB0cmFuc3BhcmVudCA9IChxdHk6IHN0cmluZykgPT4gcXR5O1xyXG4gICAgaWYgKCFvcC5jb25kaXRpb24pIHtcclxuICAgICAgcmV0dXJuIHRyYW5zcGFyZW50O1xyXG4gICAgfVxyXG4gICAgaWYgKCdwZXJjZW50JyBpbiBvcCkge1xyXG4gICAgICBjb25zdCB7IHBlcmNlbnQsIGZyb20sIGRpZ2l0cyB9ID0gb3A7XHJcbiAgICAgIGlmIChwZXJjZW50ID09IG51bGwpIHtcclxuICAgICAgICByZXR1cm4gdHJhbnNwYXJlbnQ7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIChxdHk6IHN0cmluZywgdGFnczogUHJpY2VzPFQ+KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHNmKHF0eSwgbWYodGFncy5nZXQoZnJvbSksICtwZXJjZW50IC8gMTAwLCBkaWdpdHMpKTtcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGlmICgnYW1vdW50JyBpbiBvcCkge1xyXG4gICAgICBjb25zdCB7IGFtb3VudCwgZGlnaXRzIH0gPSBvcDtcclxuICAgICAgaWYgKGFtb3VudCA9PSBudWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIHRyYW5zcGFyZW50O1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiAocXR5OiBzdHJpbmcpID0+IHNmKHF0eSwgYW1vdW50LCBkaWdpdHMpO1xyXG4gICAgfVxyXG4gICAgaWYgKCdjdXN0b20nIGluIG9wKSB7XHJcbiAgICAgIHJldHVybiBvcC5jdXN0b207XHJcbiAgICB9XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgb3BlcmF0aW9uJyk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogUmV0cmlldmVzIHRoZSBxdWFudGl0eSBhbmQgZnVsbCBxdWFudGl0eSBiYXNlZCBvbiB0aGUgZ2l2ZW4gcHJpY2UgYW5kIGRpc2NvdW50IHN0YXR1cy5cclxuICpcclxuICogQHBhcmFtIHtzdHJpbmd9IHByaWNlIC0gVGhlIHByaWNlIGluIHN0cmluZyBmb3JtYXQgdG8gYmUgcGFyc2VkLlxyXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGVuYWJsZURpc2NvdW50IC0gQSBmbGFnIGluZGljYXRpbmcgd2hldGhlciBkaXNjb3VudCBjYWxjdWxhdGlvbnMgc2hvdWxkIGJlIGVuYWJsZWQuXHJcbiAqIEByZXR1cm4ge09iamVjdH0gLSBBbiBvYmplY3QgY29udGFpbmluZyB0aGUgcXVhbnRpdGllcy4gSWYgZGlzY291bnQgaXMgZW5hYmxlZCwgYm90aCBxdHkgYW5kIGZ1bGxRdHkgYXJlIHJldHVybmVkLiBPdGhlcndpc2UsIG9ubHkgZnVsbFF0eSBpcyByZXR1cm5lZCBhcyBxdHkuXHJcbiAqL1xyXG5mdW5jdGlvbiBnZXRRdHlBbmRGdWxsUXR5KFxyXG4gIHByaWNlOiBzdHJpbmcsXHJcbiAgZW5hYmxlRGlzY291bnQ6IGJvb2xlYW5cclxuKTogeyByZWFkb25seSBxdHk6IHN0cmluZzsgcmVhZG9ubHkgZnVsbFF0eT86IHN0cmluZyB8IHVuZGVmaW5lZCB9IHtcclxuICBjb25zdCB7IHF0eSwgZnVsbFF0eSB9ID0gcGFyc2VQcmljZVdpdGhQaXBlKHByaWNlKTtcclxuICBpZiAoZW5hYmxlRGlzY291bnQpIHtcclxuICAgIHJldHVybiB7IHF0eSwgZnVsbFF0eSB9IGFzIGNvbnN0O1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4geyBxdHk6IGZ1bGxRdHkgfHwgcXR5IH0gYXMgY29uc3Q7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRvIGRpc3Rpbmd1aXNoIHRoZSBsaW5lZCBwcmljZSBmcm9tIHRoZSBhY3R1YWwgb25lXHJcbiAqIEBwYXJhbSBwcmljZSBwcmV6em8gY29uIHBvc3NpYmlsZSBwaXBlXHJcbiAqL1xyXG5mdW5jdGlvbiBwYXJzZVByaWNlV2l0aFBpcGUocHJpY2U6IHN0cmluZykge1xyXG4gIGxldCBxdHkgPSBwcmljZTtcclxuICBsZXQgZnVsbFF0eTogc3RyaW5nIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xyXG5cclxuICBpZiAocXR5Py5pbmNsdWRlcygnfCcpKSB7XHJcbiAgICBjb25zdCBzcGxpdCA9IHF0eS5zcGxpdCgnfCcpO1xyXG4gICAgZnVsbFF0eSA9IHNwbGl0WzFdO1xyXG4gICAgcXR5ID0gc3BsaXRbMF0hO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHsgcXR5LCBmdWxsUXR5IH07XHJcbn1cclxuIl0sImZpbGUiOiJDOi9Vc2Vycy9haW50cm9uYS9EZXNrdG9wL0FwcC9yZWFjdC9uYWovbGlicy9kYXRhLWFjY2Vzcy9zcmMvbGliL29mZmVydGEvY29ycmlzcGV0dGl2aS91dGlscy50cyJ9